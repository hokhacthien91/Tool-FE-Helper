(()=>{figma.showUI(__html__,{width:600,height:700});var F=!1,$={components:[],timestamp:0,pageName:null};function q(t=!1){let e=figma.currentPage.name,i=Date.now(),l=i-$.timestamp;if(!t&&$.components.length>0&&$.pageName===e&&l<3e5)return console.log("[component-cache] Using cached components:",$.components.length,"components"),$.components;console.log("[component-cache] Collecting components (cache miss or expired)");let n=[];function a(f,c=0){if(c>100){console.warn("[component-cache] Max depth reached, stopping traversal");return}try{if(f.type==="COMPONENT"&&n.push({id:f.id,name:f.name,description:f.description||""}),"children"in f&&Array.isArray(f.children))for(let d of f.children)try{a(d,c+1)}catch(p){console.warn("[component-cache] Could not access child:",p)}}catch(d){console.warn("[component-cache] Could not access node:",d)}}console.log("[component-cache] Scanning current page:",e),a(figma.currentPage);let r=figma.root.children.filter(f=>f.type==="PAGE").slice(0,10);if(r.length>1){console.log(`[component-cache] Also scanning ${r.length-1} additional page(s)`);for(let f=1;f<r.length;f++)try{a(r[f])}catch(c){console.warn(`[component-cache] Could not scan page ${r[f].name}:`,c)}}return n.sort((f,c)=>(f.name||"").localeCompare(c.name||"")),$={components:n,timestamp:i,pageName:e},console.log("[component-cache] Cached",n.length,"components"),n}function ae(t){if(!t||!t.id)return;$.components.some(i=>i.id===t.id)||($.components.push(t),$.components.sort((i,l)=>(i.name||"").localeCompare(l.name||"")),console.log("[component-cache] Added new component to cache:",t.name))}function P(t,e,i=!0){if(i&&"visible"in t&&t.visible===!1)return;let l=(t.name||"").toLowerCase();if(!(l.includes("sticky note")||l.includes("not check design"))&&(e(t),"children"in t))for(let o of t.children)P(o,e,i)}function V(t){let e=figma.root&&figma.root.name?figma.root.name:"Untitled File",i=figma.currentPage&&figma.currentPage.name?figma.currentPage.name:"Unnamed Page";if(t!=="selection")return{mode:"page",fileName:e,pageName:i,label:`File: ${e} \u2022 Page: ${i}`};let l=Array.isArray(figma.currentPage.selection)?figma.currentPage.selection:[];if(!l.length)return{mode:"page",fileName:e,pageName:i,label:`File: ${e} \u2022 Page: ${i}`};function o(f){let c=f,d=null;for(;c&&c.type!=="PAGE";)(c.type==="FRAME"||c.type==="COMPONENT"||c.type==="INSTANCE")&&(d=c),c=c.parent;return d&&d.name?d.name:f&&f.name?f.name:"Selection"}let n=new Set;for(let f of l)try{n.add(o(f))}catch(c){}let a=Array.from(n).filter(Boolean);if(a.length===1)return{mode:"selection",fileName:e,pageName:i,label:`File: ${e} \u2022 Selection: ${a[0]}`};let s=a.slice(0,2).join(", "),r=a.length>2?` (+${a.length-2} more)`:"";return{mode:"selection",fileName:e,pageName:i,label:`File: ${e} \u2022 Selection: ${s}${r}`}}var v={namingPatterns:{frame:/^(Section|Block|Item|Media|Title|Desc|Button|Card|Header|Footer|Nav|Sidebar|Container|Wrapper|Grid|List|Form|Input|Label|Icon|Image|Avatar|Badge|Tag|Tooltip|Modal|Dialog|Dropdown|Menu|Tab|Accordion|Breadcrumb|Pagination|Slider|Carousel|Table|Row|Col|Cell)/i,component:/^(Card|Button|Header-item|CTA|Input|Select|Checkbox|Radio|Switch|Textarea|Label|Icon|Image|Avatar|Badge|Tag|Tooltip|Modal|Dialog|Dropdown|Menu|Tab|Accordion|Breadcrumb|Pagination|Slider|Carousel|Table|Row|Col|Cell)/i,text:/^(Title|Desc|Label|Caption|Heading|Subheading|Body|Link|Button-text|Content)/i},checkAutoLayout:!0,preferredLayoutMode:"VERTICAL",spacingScale:[8,12,16,24,32,40,48,64],gapScale:[8,12,16,24,32,40,48,64],disallowGroups:!0,disallowNestedGroups:!0,checkEmptyFrames:!0,checkDuplicateFrames:!0,breakpoints:{mobile:{min:0,max:768},tablet:{min:768,max:1024},desktop:{min:1024,max:1/0}},typographySizes:{h1:32,h2:24,h3:20,h4:18,body:[14,16,18],caption:12},allTypographySizes:[32,24,20,18,16,14,12],disallowLineHeightAuto:!0,disallowLineHeightBaseline:!0,requireTextStyleKey:!0,requireComponentization:!0,componentPatterns:["Card","Button","Header-item","CTA","Input","Select","Checkbox","Radio","Switch","Textarea","Label","Icon","Image","Avatar","Badge","Tag","Tooltip","Modal","Dialog","Dropdown","Menu","Tab","Accordion","Breadcrumb","Pagination","Slider","Carousel","Table","Row","Col","Cell"],allowedTextStyleIds:[],checkNegativePosition:!0,checkTextContrast:!0,contrastAA:4.5,contrastAALarge:3,checkTextSizeMobile:!0,mobileMinTextSize:16,mobileMinTextSizeBold:14},C={lastReport:"design-qa-last-report",history:"design-qa-history",inputValues:"design-qa-input-values",savedSettings:"design-qa-saved-settings"},re=10;function Y(t){if(t.type==="FRAME"||t.type==="COMPONENT"||t.type==="INSTANCE"){let e="children"in t?t.children.map(i=>`${i.type}:${i.name||""}`).join(","):"";return`${t.type}|${t.name||""}|${e}|${Math.round(t.width||0)}x${Math.round(t.height||0)}|${t.layoutMode||"NONE"}`}return null}function K(t,e){if(typeof t!="number")return!1;let i=Math.abs(Math.round(t));return e.includes(i)}function le(t){return typeof t!="number"?!1:v.allTypographySizes.includes(Math.round(t))}function Z(t,e,i){let[l,o,n]=[t,e,i].map(a=>(a=a/255,a<=.03928?a/12.92:Math.pow((a+.055)/1.055,2.4)));return .2126*l+.7152*o+.0722*n}function ce(t,e,i){let l=e.a!==void 0?e.a:1,o=(t.a!==void 0?t.a:1)*i,n=t.r*o+e.r*l*(1-o),a=t.g*o+e.g*l*(1-o),s=t.b*o+e.b*l*(1-o);return{r:n,g:a,b:s,a:1}}function W(t){if(t.parent&&t.parent.type!=="PAGE"){let e=t.parent;if("fills"in e&&Array.isArray(e.fills)&&e.fills.length>0)for(let i=e.fills.length-1;i>=0;i--){let l=e.fills[i];if(l.visible!==!1&&l.type==="SOLID"){let o=l.opacity!==void 0?l.opacity:1;return(l.color.a!==void 0?l.color.a:1)*o<1?W(e):l.color}}if(e.parent&&e.parent.type!=="PAGE")return W(e)}return{r:1,g:1,b:1,a:1}}function fe(t,e){let i=Z(t.r*255,t.g*255,t.b*255),l=Z(e.r*255,e.g*255,e.b*255),o=Math.max(i,l),n=Math.min(i,l);return(o+.05)/(n+.05)}function U(t){if(!t||!t.gradientStops||t.gradientStops.length===0)return null;let e=t.gradientStops;if(e.length===1)return e[0].color;let i=[...e].sort((r,f)=>r.position-f.position),l=0,o=0,n=0,a=0,s=0;for(let r=0;r<i.length;r++){let f=i[r],c=i[r+1],d=c?c.position-f.position:1-f.position;o+=f.color.r*d,n+=f.color.g*d,a+=f.color.b*d,s+=(f.color.a!==void 0?f.color.a:1)*d,l+=d}if(l===0){o=n=a=s=0,e.forEach(f=>{o+=f.color.r,n+=f.color.g,a+=f.color.b,s+=f.color.a!==void 0?f.color.a:1});let r=e.length;return{r:o/r,g:n/r,b:a/r,a:s/r}}return{r:o/l,g:n/l,b:a/l,a:s/l}}function de(t,e){if(!t||!e||!("x"in t)||!("y"in t)||!("width"in t)||!("height"in t)||!("x"in e)||!("y"in e)||!("width"in e)||!("height"in e))return!1;let i=e.parent;if(i&&"children"in i){let l=i.children.indexOf(e),o=i.children.indexOf(t);if(o===-1||l===-1)return!1;if(o<l){let n=t.x+t.width,a=t.y+t.height,s=e.x+e.width,r=e.y+e.height,f=Math.max(0,Math.min(n,s)-Math.max(t.x,e.x)),c=Math.max(0,Math.min(a,r)-Math.max(t.y,e.y)),d=f*c,p=(s-e.x)*(r-e.y);if(p>0&&d/p>=.5||t.x<=e.x&&t.y<=e.y&&n>=s&&a>=r)return!0}}return!1}function ue(t){let e=t.type==="TEXT";if(e&&t.parent&&"children"in t.parent){let l=t.parent,o=l.children.indexOf(t);for(let n=0;n<o;n++){let a=l.children[n];if(!("visible"in a&&a.visible===!1)&&a.type!=="TEXT"&&de(a,t)&&"fills"in a&&Array.isArray(a.fills)&&a.fills.length>0)for(let s=a.fills.length-1;s>=0;s--){let r=a.fills[s];if(r.visible!==!1){if(r.type==="SOLID")return{color:r.color,nodeName:a.name||"Unnamed",nodeId:a.id,fromSibling:!0,fillOpacity:r.opacity!==void 0?r.opacity:1};if(r.type==="GRADIENT_LINEAR"||r.type==="GRADIENT_RADIAL"||r.type==="GRADIENT_ANGULAR"||r.type==="GRADIENT_DIAMOND"){let f=U(r),c=B(r);if(f)return{color:f,nodeName:a.name||"Unnamed",nodeId:a.id,isGradient:!0,gradientType:r.type,gradientString:c,fromSibling:!0}}}}}}if(!e&&"fills"in t&&Array.isArray(t.fills)&&t.fills.length>0)for(let l=t.fills.length-1;l>=0;l--){let o=t.fills[l];if(o.visible!==!1){if(o.type==="SOLID")return{color:o.color,nodeName:t.name||"Unnamed",nodeId:t.id,fillOpacity:o.opacity!==void 0?o.opacity:1};if(o.type==="GRADIENT_LINEAR"||o.type==="GRADIENT_RADIAL"||o.type==="GRADIENT_ANGULAR"||o.type==="GRADIENT_DIAMOND"){let n=U(o),a=B(o);if(n)return{color:n,nodeName:t.name||"Unnamed",nodeId:t.id,isGradient:!0,gradientType:o.type,gradientString:a}}}}let i=t.parent;for(;i&&i.type!=="PAGE";){if("fills"in i&&Array.isArray(i.fills)&&i.fills.length>0)for(let l=i.fills.length-1;l>=0;l--){let o=i.fills[l];if(o.visible!==!1){if(o.type==="SOLID")return{color:o.color,nodeName:i.name||"Unnamed",nodeId:i.id,fillOpacity:o.opacity!==void 0?o.opacity:1};if(o.type==="GRADIENT_LINEAR"||o.type==="GRADIENT_RADIAL"||o.type==="GRADIENT_ANGULAR"||o.type==="GRADIENT_DIAMOND"){let n=U(o),a=B(o);if(n)return{color:n,nodeName:i.name||"Unnamed",nodeId:i.id,isGradient:!0,gradientType:o.type,gradientString:a};break}}}i=i.parent}return{color:{r:1,g:1,b:1},nodeName:"Default (white)",nodeId:null}}function ge(t){if(t.type!=="TEXT"||!v.checkTextContrast)return null;let e=null;if("fills"in t&&Array.isArray(t.fills)&&t.fills.length>0){for(let N of t.fills)if(N.type==="SOLID"&&N.visible!==!1){e=N.color;break}}if(!e)return null;let i=ue(t),l=i.color,o=i.fillOpacity!==void 0?i.fillOpacity:1,a=(l.a!==void 0?l.a:1)*o;if(a<1){let N=null;if(i.nodeId)try{N=figma.getNodeById(i.nodeId)}catch(M){N=t.parent}else N=t.parent;let E=N?W(N):{r:1,g:1,b:1,a:1};l=ce(l,E,a)}let s=fe(e,l),r=t.fontSize&&typeof t.fontSize=="number"&&!isNaN(t.fontSize)?t.fontSize:14,f=t.fontName&&t.fontName.style?t.fontName.style.toLowerCase():"",c=r>=18||r>=14&&f.includes("bold"),d=c?v.contrastAALarge:v.contrastAA,p=R(e),y=R(l,o),g=t.name||"Unnamed",m=i.nodeName||"Unknown",w=i.isGradient||!1,b=i.gradientType||null,A=i.gradientString||null;if(s<d){let N="error",E=`Text contrast ratio ${s.toFixed(2)}:1 fails WCAG ${c?"AA (large text)":"AA"} (requires >= ${d}:1). Text: "${t.characters.slice(0,30)}"`;return w?(N="warn",E=`Text contrast ratio ${s.toFixed(2)}:1 fails WCAG ${c?"AA (large text)":"AA"} (requires >= ${d}:1) with a gradient background. Manual check recommended because gradients may pass at some positions. Text: "${t.characters.slice(0,30)}"`):Math.abs(s-1)<.01&&(N="warn",E=`Text contrast ratio ${s.toFixed(2)}:1 \u2014 background color may not have been detected correctly (e.g. a sibling layer behind the text). Manual check recommended. Text: "${t.characters.slice(0,30)}"`),{severity:N,type:"contrast",message:E,id:t.id,nodeName:g,contrast:s,fontSize:r,isLargeText:c,minContrast:d,textColor:p,textColorNode:g,backgroundColor:y,backgroundColorNode:m,isGradient:w,gradientType:b,gradientString:A,fromSibling:i.fromSibling||!1}}return null}function pe(t){if(!t||!t.parent)return!1;let e=t.parent;for(;e&&e.type!=="PAGE";){if((e.type==="FRAME"||e.type==="COMPONENT"||e.type==="INSTANCE")&&"width"in e&&typeof e.width=="number"){let i=e.width;return i>0&&i<=v.breakpoints.mobile.max}e=e.parent}return!0}function me(t){if(t.type!=="TEXT"||!v.checkTextSizeMobile||!pe(t))return null;let e=t.fontSize&&typeof t.fontSize=="number"&&!isNaN(t.fontSize)?t.fontSize:null;if(!e)return null;if(e<=12){let i=t.characters?t.characters.slice(0,30):"";return{severity:"error",type:"text-size-mobile",message:`Text is too small (${e}px) \u2014 ADA non-compliant. Font sizes of 12px or smaller are not allowed. Text: "${i}"`,id:t.id,nodeName:t.name||"Unnamed",fontSize:e,minSize:12,textPreview:i}}return null}function ye(t,e=null,i=300,l=120){if(t.type!=="TEXT"||!t.lineHeight)return null;let o=e&&e.allowAuto;if(t.lineHeight.unit==="AUTO")return o?null:{severity:"warn",type:"line-height",message:'Line-height is set to "AUTO" \u2014 set an explicit value to ensure spacing calculations are accurate.',id:t.id,nodeName:t.name||"Unnamed"};let n=null,a=null,s=t.fontSize&&typeof t.fontSize=="number"&&!isNaN(t.fontSize)?t.fontSize:null;if(t.lineHeight.unit==="PERCENT"?(n=Math.round(t.lineHeight.value),s&&(a=Math.round(t.lineHeight.value/100*s*100)/100)):t.lineHeight.unit==="PIXELS"&&s&&typeof s=="number"&&(a=t.lineHeight.value,n=Math.round(t.lineHeight.value/s*100)),n===null||n>i)return null;if(e!==null&&e.values&&e.values.length>0){if(e.values.includes(n))return null;let r=o?`auto, ${e.values.join(", ")}`:e.values.join(", "),f="";return s&&a!==null?f=` (font-size: ${s}px / line-height: ${a}px)`:s&&(f=` (font-size: ${s}px)`),{severity:"warn",type:"line-height",message:`Line-height ${n}%${f} kh\xF4ng theo scale. Scale: ${r}%`,id:t.id,nodeName:t.name||"Unnamed"}}if(v.disallowLineHeightBaseline){if(s&&typeof s=="number"&&t.lineHeight.unit==="PIXELS"){let r=t.lineHeight.value,f=r/s;if(Math.round(f*100)<l)return{severity:"warn",type:"line-height",message:`Line-height ${n}% (font-size: ${s}px / line-height: ${r}px) too close to font-size \u2014 could cause spacing calculation errors between elements. Should use line-height >= ${l}% (>= ${(l/100).toFixed(1)}x font-size).`,id:t.id,nodeName:t.name||"Unnamed"}}else if(s&&typeof s=="number"&&t.lineHeight.unit==="PERCENT"&&n<l){let r=a!==null?a:Math.round(n/100*s);return{severity:"warn",type:"line-height",message:`Line-height ${n}% (font-size: ${s}px / line-height: ${r}px) too close to font-size \u2014 could cause spacing calculation errors between elements. Should use line-height >= ${l}% (>= ${(l/100).toFixed(1)}x font-size).`,id:t.id,nodeName:t.name||"Unnamed"}}}return null}function he(t){let e=[],i=t;for(;i&&i.type!=="PAGE";)e.unshift(i.name||"Unnamed"),i=i.parent;return e.join(" > ")}function ne(t){let e=t.parent;for(;e&&e.type!=="PAGE";){if(e.type==="COMPONENT"||e.type==="INSTANCE")return!0;e=e.parent}return!1}function ie(t){let e=t.parent;for(;e&&e.type!=="PAGE";){if(e.type==="INSTANCE")return!0;e=e.parent}return!1}function J(t){if(t.type!=="FRAME"&&t.type!=="INSTANCE"||t.type==="COMPONENT"||t.type==="INSTANCE"||ne(t))return!1;let e=(t.name||"").toLowerCase();for(let i of v.componentPatterns)if(e.includes(i.toLowerCase()))return!0;if("children"in t&&t.children.length>0){let i=t.children.some(o=>o.type==="TEXT"),l=t.children.length>=2;if(i&&l)return!0}return!1}function oe(t){if(!("children"in t)||t.children.length===0)return!1;let e=t.children.every(i=>i.type==="RECTANGLE"||i.type==="ELLIPSE"||i.type==="POLYGON"||i.type==="STAR"||i.type==="VECTOR"||i.type==="LINE"||i.type==="BOOLEAN_OPERATION");if(t.children.length===1){let i=t.children[0],l=(i.name||"").toLowerCase();if(i.type==="RECTANGLE"||i.type==="ELLIPSE"||l.includes("background")||l.includes("bg")||l.includes("shape")||l.includes("container"))return!0}return e&&t.children.length<=3}function Q(t){if(!("children"in t)||t.children.length===0)return!1;let e=t.children,i=e.map(a=>a.type),l=e.map(a=>(a.name||"").toLowerCase()),o=i.includes("TEXT"),n=i.some((a,s)=>a==="VECTOR"||a==="COMPONENT"||a==="INSTANCE"||l[s].includes("icon"));if(o&&n&&e.length<=3)return!0;if(o){let a=i.includes("RECTANGLE")||i.includes("ELLIPSE"),s=i.some((r,f)=>r==="GROUP"&&"children"in e[f]?oe(e[f]):!1);if((a||s)&&e.length<=3)return!0}return!!(e.length>=2&&e.length<=4&&e.every(s=>s.type==="TEXT"||s.type==="VECTOR"||s.type==="RECTANGLE"||s.type==="ELLIPSE"||s.type==="COMPONENT"||s.type==="INSTANCE"||s.type==="FRAME"))}function se(t){if(!t||t.type!=="GROUP"||!("children"in t)||!Array.isArray(t.children)||t.children.length===0)return!1;let e=new Set(["TEXT","FRAME","INSTANCE","COMPONENT"]);for(let l of t.children){if(!l||e.has(l.type))return!1;if(l.type==="GROUP"){if(!se(l))return!1;continue}}let i=new Set(["VECTOR","BOOLEAN_OPERATION","STAR","LINE","ELLIPSE","POLYGON","RECTANGLE"]);return t.children.every(l=>l&&(i.has(l.type)||l.type==="GROUP"))}function Ne(t){if(t.type!=="GROUP"||!("children"in t)||!t.children.some(n=>n.type==="GROUP")||t.children.length>=2||Q(t))return!1;for(let n of t.children)if(n.type==="GROUP"&&"children"in n&&n.children.some(s=>s.type==="GROUP"))return!0;let i=t.children.filter(n=>n.type==="GROUP"),l=t.children.filter(n=>n.type!=="GROUP");return!(l.some(n=>n.type==="TEXT")&&i.length===1&&oe(i[0])||i.length===1&&Q(i[0])&&l.length>0)}function Se(t,e){if(!("x"in t)||!("y"in t)||!("width"in t)||!("height"in t)||!("x"in e)||!("y"in e)||!("width"in e)||!("height"in e))return!1;let i=t.x+t.width,l=t.y+t.height,o=e.x+e.width,n=e.y+e.height;return!(i<=e.x||t.x>=o||l<=e.y||t.y>=n)}function xe(t){if(!("children"in t)||t.children.length===0)return{required:!1,message:null};let e=t.children,i=e.length,l=(t.name||"").toLowerCase();if(i===1)return{required:!1,message:null};if(l.includes("bg")||l.includes("background")||l.includes("overlay")||l.includes("shadow")||l.includes("decoration"))return{required:!1,message:null};if(i===1){let a=e[0];if((a.type==="IMAGE"||a.type==="VECTOR")&&a.type!=="TEXT")return{required:!1,message:null}}let o=!1;for(let a=0;a<e.length;a++){for(let s=a+1;s<e.length;s++)if(Se(e[a],e[s])){o=!0;break}if(o)break}if(o)return{required:!1,message:null};if(i===1&&e[0].type==="TEXT")return{required:!0,message:`Auto-layout is not enabled on ${t.type} "${t.name||"Unnamed"}" \u2014 Text can change length, should use Auto Layout.`};if(i===2){let a=e.some(r=>r.type==="TEXT"),s=e.some(r=>r.type==="VECTOR"||r.type==="COMPONENT"||r.type==="INSTANCE"||r.name&&r.name.toLowerCase().includes("icon"));if(a&&s){let r=e[0],f=e[1];if("x"in r&&"y"in r&&"x"in f&&"y"in f){let c=Math.abs(r.x-f.x),d=Math.abs(r.y-f.y);if(c<10||d<10)return{required:!0,message:`Auto-layout is not enabled on ${t.type} "${t.name||"Unnamed"}" \u2014 Button/Label pattern (Icon + Text) should use Auto Layout.`}}}}if(i>=2&&e.every(a=>a.type==="TEXT")){let a=e.map(s=>"y"in s?s.y:0).sort((s,r)=>s-r);if(a.length>=2){let s=[];for(let r=1;r<a.length;r++)s.push(a[r]-a[r-1]);if(s.length>0){let r=s.reduce((c,d)=>c+d,0)/s.length;if(s.every(c=>Math.abs(c-r)<5))return{required:!0,message:`Auto-layout is not enabled on ${t.type} "${t.name||"Unnamed"}" \u2014 Text stack (title + description) should use Auto Layout.`}}}}if(i>=3){let a=e.map(r=>"x"in r?r.x:0).sort((r,f)=>r-f),s=e.map(r=>"y"in r?r.y:0).sort((r,f)=>r-f);if(a.length>=3){let r=[];for(let f=1;f<a.length;f++)r.push(a[f]-a[f-1]);if(r.length>0){let f=r.reduce((d,p)=>d+p,0)/r.length;if(r.every(d=>Math.abs(d-f)<2)&&f>0)return{required:!0,message:`Auto-layout is not enabled on ${t.type} "${t.name||"Unnamed"}" \u2014 Even spacing between children, should use Auto Layout.`}}}if(s.length>=3){let r=[];for(let f=1;f<s.length;f++)r.push(s[f]-s[f-1]);if(r.length>0){let f=r.reduce((d,p)=>d+p,0)/r.length;if(r.every(d=>Math.abs(d-f)<2)&&f>0)return{required:!0,message:`Auto-layout is not enabled on ${t.type} "${t.name||"Unnamed"}" \u2014 Even spacing between children, should use Auto Layout.`}}}}if(i>0&&"width"in t&&"height"in t){let a=Math.min(...e.map(g=>"x"in g?g.x:0)),s=Math.min(...e.map(g=>"y"in g?g.y:0)),r=Math.max(...e.map(g=>"x"in g&&"width"in g?g.x+g.width:0)),f=Math.max(...e.map(g=>"y"in g&&"height"in g?g.y+g.height:0)),c=a,d=s,p=t.width-r,y=t.height-f;if(c>0&&d>0&&p>0&&y>0){let g=(c+d+p+y)/4;if(Math.abs(c-g)<5&&Math.abs(d-g)<5&&Math.abs(p-g)<5&&Math.abs(y-g)<5)return{required:!0,message:`Auto-layout is not enabled on ${t.type} "${t.name||"Unnamed"}" \u2014 Frame has manual padding, should use Auto Layout.`}}}if(t.type==="COMPONENT")return{required:!0,message:`Auto-layout is not enabled on Component "${t.name||"Unnamed"}" \u2014 Component reusable should use Auto Layout.`};if(i>0&&e.some(s=>{if("constraints"in s&&s.constraints){let r=s.constraints;return r.horizontal==="LEFT_RIGHT"||r.horizontal==="SCALE"||r.vertical==="TOP_BOTTOM"||r.vertical==="SCALE"}return!1}))return{required:!0,message:`Auto-layout is not enabled on ${t.type} "${t.name||"Unnamed"}" \u2014 Frame has responsive constraints, should use Auto Layout.`};if(i>=3){let a=e.map(r=>"width"in r?r.width:0),s=e.map(r=>"height"in r?r.height:0);if(a.length>0&&s.length>0){let r=a.reduce((g,m)=>g+m,0)/a.length,f=s.reduce((g,m)=>g+m,0)/s.length,c=a.every(g=>Math.abs(g-r)<2)&&s.every(g=>Math.abs(g-f)<2),d=e.map(g=>"x"in g?g.x:0).sort((g,m)=>g-m),p=e.map(g=>"y"in g?g.y:0).sort((g,m)=>g-m),y=!1;if(d.length>=3){let g=[];for(let w=1;w<d.length;w++)g.push(d[w]-d[w-1]);let m=g.reduce((w,b)=>w+b,0)/g.length;y=g.every(w=>Math.abs(w-m)<2)}if(!y&&p.length>=3){let g=[];for(let w=1;w<p.length;w++)g.push(p[w]-p[w-1]);let m=g.reduce((w,b)=>w+b,0)/g.length;y=g.every(w=>Math.abs(w-m)<2)}if(c&&y)return{required:!0,message:`Auto-layout is not enabled on ${t.type} "${t.name||"Unnamed"}" \u2014 List/Grid pattern (children same size), should use Auto Layout.`}}}return/button|badge|tag|chip|pill|input|field|navbar|menu|list/i.test(l)?{required:!0,message:`Auto-layout is not enabled on ${t.type} "${t.name||"Unnamed"}" \u2014 Standard UI pattern should use Auto Layout.`}:{required:!0,message:`Auto-layout is not enabled on ${t.type} "${t.name||"Unnamed"}" \u2014 requires 100% Auto-layout.`}}function _(t){if("fills"in t&&Array.isArray(t.fills)&&t.fills.length>0){for(let e of t.fills)if(e.visible!==!1&&(e.type==="SOLID"||e.type==="GRADIENT_LINEAR"||e.type==="GRADIENT_RADIAL"||e.type==="GRADIENT_ANGULAR"||e.type==="GRADIENT_DIAMOND"||e.type==="IMAGE"))return!0}if("effects"in t&&Array.isArray(t.effects)&&t.effects.length>0){for(let e of t.effects)if(e.visible!==!1&&(e.type==="DROP_SHADOW"||e.type==="INNER_SHADOW"||e.type==="LAYER_BLUR"||e.type==="BACKGROUND_BLUR"))return!0}if("strokes"in t&&Array.isArray(t.strokes)&&t.strokes.length>0){for(let e of t.strokes)if(e.visible!==!1)return!0}return!1}function we(t){if(t.type!=="FRAME"&&t.type!=="COMPONENT"||!("children"in t))return!1;if(_(t))return null;if(t.children.length===0)return{type:"empty",message:"Empty frame \u2014 remove it or add content."};if(t.children.length===1&&t.layoutMode==="NONE"){let e=t.children[0];if(Math.abs((e.width||0)-(t.width||0))<1&&Math.abs((e.height||0)-(t.height||0))<1)return _(t)||t.paddingLeft&&t.paddingLeft>0||t.paddingRight&&t.paddingRight>0||t.paddingTop&&t.paddingTop>0||t.paddingBottom&&t.paddingBottom>0||e.x!==0||e.y!==0||t.type==="COMPONENT"||t.type==="INSTANCE"?null:{type:"redundant",message:"Frame only contains 1 child with the same size \u2014 it might be a redundant frame."}}return null}function j(t){if(!t)return null;let e=t.trim().toUpperCase();if(e.startsWith("#")){let i=e.slice(1);return i.length===3?"#"+i[0]+i[0]+i[1]+i[1]+i[2]+i[2]:e}return e}function X(t,e){if(!t||!e||!Array.isArray(e))return!1;let i=j(t);return i?e.some(l=>j(l)===i):!1}function ee(t,e,i){if(t.type!=="TEXT"||!e||e.length===0||!i||!i.checkStyle)return null;let l=t.fontSize&&typeof t.fontSize=="number"?Math.round(t.fontSize):null,o=t.fontName&&typeof t.fontName=="object"?t.fontName.family:null,n=t.fontName&&typeof t.fontName=="object"?t.fontName.style:null,a=null;t.lineHeight&&t.lineHeight.unit==="PERCENT"?a=`${Math.round(t.lineHeight.value)}%`:t.lineHeight&&t.lineHeight.unit==="AUTO"?a="auto":t.lineHeight&&t.lineHeight.unit==="PIXELS"&&l&&(a=`${Math.round(t.lineHeight.value/l*100)}%`);let s=null;t.letterSpacing&&typeof t.letterSpacing=="object"?t.letterSpacing.unit==="PERCENT"?s=`${t.letterSpacing.value}%`:t.letterSpacing.unit==="PIXELS"&&(s=`${t.letterSpacing.value}px`):typeof t.letterSpacing=="number"&&(s=`${t.letterSpacing}`);let r=null;if("fills"in t&&Array.isArray(t.fills)&&t.fills.length>0){for(let m of t.fills)if(m.type==="SOLID"&&m.visible!==!1){r=R(m.color);break}}let f=null,c=0;for(let m of e){let w=0,b=0;if(i.checkFontSize&&l!==null&&m.fontSize&&(b++,l===parseInt(m.fontSize)&&w++),i.checkFontFamily&&o&&m.fontFamily&&(b++,(o.toLowerCase().includes(m.fontFamily.toLowerCase())||m.fontFamily.toLowerCase().includes(o.toLowerCase()))&&w++),i.checkFontWeight&&n&&m.fontWeight&&(b++,(n.toLowerCase().includes(m.fontWeight.toLowerCase())||m.fontWeight.toLowerCase().includes(n.toLowerCase()))&&w++),i.checkLineHeight&&a&&m.lineHeight){b++;let A=String(m.lineHeight).toLowerCase();a.toLowerCase()===A&&w++}if(i.checkLetterSpacing&&s!==null&&m.letterSpacing!==void 0){b++;let A=String(m.letterSpacing).toLowerCase().trim(),N=s.toLowerCase().trim(),E=M=>M==="0"||M==="0px"||M==="0%";(E(A)&&E(N)||A===N)&&w++}if(i.checkWordSpacing&&m.wordSpacing,b>0&&w===b)return{matched:!0,styleName:m.name,nodeProps:{fontFamily:o,fontSize:l,fontWeight:n,lineHeight:a,letterSpacing:s},styleProps:{fontFamily:m.fontFamily,fontSize:m.fontSize,fontWeight:m.fontWeight,lineHeight:m.lineHeight,letterSpacing:m.letterSpacing}};b>0&&w>c&&(c=w,f=m)}let d=t.characters?t.characters.slice(0,30):"",p=0;i.checkFontFamily&&p++,i.checkFontSize&&p++,i.checkFontWeight&&p++,i.checkLineHeight&&p++,i.checkLetterSpacing&&p++,i.checkWordSpacing&&p++;let y=[];if(f){if(i.checkFontFamily&&o&&f.fontFamily){let m=o.toLowerCase().includes(f.fontFamily.toLowerCase())||f.fontFamily.toLowerCase().includes(o.toLowerCase());y.push({property:"Font Family",current:o,expected:f.fontFamily,matches:m})}if(i.checkFontSize&&l!==null&&f.fontSize){let m=l===parseInt(f.fontSize);y.push({property:"Font Size",current:l+"px",expected:f.fontSize+"px",matches:m})}if(i.checkFontWeight&&n&&f.fontWeight){let m=n.toLowerCase().includes(f.fontWeight.toLowerCase())||f.fontWeight.toLowerCase().includes(n.toLowerCase());y.push({property:"Font Weight",current:n,expected:f.fontWeight,matches:m})}if(i.checkLineHeight&&a&&f.lineHeight){let m=a.toLowerCase()===String(f.lineHeight).toLowerCase();y.push({property:"Line Height",current:a,expected:f.lineHeight,matches:m})}if(i.checkLetterSpacing&&s!==null&&f.letterSpacing!==void 0){let m=N=>N==="0"||N==="0px"||N==="0%",w=String(f.letterSpacing).toLowerCase().trim(),b=s.toLowerCase().trim(),A=m(w)&&m(b)||w===b;y.push({property:"Letter Spacing",current:s,expected:f.letterSpacing,matches:A})}}let g=0;return p>0&&c>0&&(g=Math.round(c/p*100)),{matched:!1,message:`Typography does not match any defined style. Text: "${d}"`,textPreview:d,nodeProps:{fontFamily:o,fontSize:l,fontWeight:n,lineHeight:a,letterSpacing:s},bestMatch:f?{name:f.name,score:c,total:p,percentage:g,differences:y}:null}}async function be(t,e=null,i=100,l=null,o=null,n=100,a=null,s=300,r=120,f=[],c={}){let d=[];if(t==="selection")if(figma.currentPage.selection.length===0)figma.notify("No selection \u2014 scanning the whole page."),P(figma.currentPage,u=>d.push(u));else for(let u of figma.currentPage.selection)P(u,x=>d.push(x));else P(figma.currentPage,u=>d.push(u));let p=[],y=new Map,g=[],m=[],w=new Set,b=new Map,A=new Map;function N(u){if(u.type==="contrast"){let T=`${u.contrast.toFixed(2)}|${u.textColor}|${u.backgroundColor}|${u.backgroundColorNode}`;b.has(T)||b.set(T,[]),b.get(T).push(u);return}let x=u.message||"",h=u.nodeName?u.nodeName.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"):"";h&&(x=x.replace(new RegExp(`"${h}"`,"g"),""),x=x.replace(new RegExp(`'${h}'`,"g"),""),x=x.replace(new RegExp(h,"g"),""),x=x.trim());let S=u.nodeName||"";try{let T=figma.getNodeById(u.id);T&&(S=he(T))}catch(T){}let I=`${u.type}|${u.severity}|${u.message}|${u.nodeName||""}`;A.has(I)||A.set(I,[]),A.get(I).push(u)}for(let u of d)try{if("visible"in u&&u.visible===!1)continue;if(u.type==="FRAME"||u.type==="COMPONENT"){let x=Y(u);x&&(y.has(x)||y.set(x,[]),y.get(x).push(u))}}catch(x){}let E=d.length,M=0,k=Math.max(1,Math.floor(E/50));for(let u of d)try{if(F)throw figma.notify("Scan cancelled by user"),F=!1,new Error("Scan cancelled");if(M++,M%k===0||M===E){let h=Math.round(M/E*100);figma.ui.postMessage({type:"scan-progress",progress:h,current:M,total:E}),await new Promise(S=>setTimeout(S,0))}if("visible"in u&&u.visible===!1)continue;let x=u.name||"Unnamed";if((u.type==="FRAME"||u.type==="COMPONENT"||u.type==="INSTANCE")&&/frame|group/i.test(x)&&N({severity:"warn",type:"naming",message:`Naming does not follow convention: "${x}". Should be named with a meaningful name instead of default name.`,id:u.id,nodeName:x}),u.type==="TEXT"){let h=x.toLowerCase()==="content",S=x.length>20&&x.split(/\s+/).length>=3,I=u.characters&&u.characters.trim()===x.trim(),T=x.split(/\s+/).length,L=T>=1&&T<=3&&x.length<=50;!h&&!S&&!I&&!L&&!v.namingPatterns.text.test(x)&&N({severity:"warn",type:"naming",message:`Text naming does not follow convention: "${x}". Should be named with a meaningful name instead of default name.`,id:u.id,nodeName:x})}if(u.type==="GROUP"){if(g.push(u),se(u))continue;v.disallowGroups&&"children"in u&&u.children.length>1&&N({severity:"error",type:"group",message:"Group detected \u2014 should use Frame + Auto-layout instead.",id:u.id,nodeName:x}),v.disallowNestedGroups&&Ne(u)&&N({severity:"error",type:"nested-group",message:"Nested groups detected \u2014 structure is not recommended.",id:u.id,nodeName:x})}if(v.checkAutoLayout&&(u.type==="FRAME"||u.type==="COMPONENT"||u.type==="INSTANCE"))if(u.layoutMode==="NONE"){let h=xe(u);h.required&&N({severity:"error",type:"autolayout",message:h.message||`Auto-layout is not enabled on ${u.type} "${x}" \u2014 requires 100% Auto-layout.`,id:u.id,nodeName:x})}else{e!==null?typeof u.itemSpacing=="number"&&(u.itemSpacing>i||K(u.itemSpacing,e)||N({severity:"error",type:"spacing",message:`Gap (itemSpacing: ${u.itemSpacing}px) does not follow scale on "${x}". Scale: ${e.join(", ")}`,id:u.id,nodeName:x})):typeof u.itemSpacing=="number"&&N({severity:"info",type:"spacing",message:`Gap (itemSpacing: ${u.itemSpacing}px) - Check spacing is skipped (spacing guidelines is empty).`,id:u.id,nodeName:x});let h=[{name:"paddingLeft",value:u.paddingLeft},{name:"paddingRight",value:u.paddingRight},{name:"paddingTop",value:u.paddingTop},{name:"paddingBottom",value:u.paddingBottom}];if(e!==null){for(let S of h)if(typeof S.value=="number"&&S.value!==0){if(S.value>i)continue;if(!K(S.value,e)){N({severity:"error",type:"spacing",message:`Padding ${S.name} (${S.value}px) does not follow scale on "${x}". Scale: ${e.join(", ")}`,id:u.id,nodeName:x});break}}}else h.some(I=>typeof I.value=="number"&&I.value!==0)&&N({severity:"info",type:"spacing",message:"Padding - Check spacing is skipped (spacing guidelines is empty).",id:u.id,nodeName:x})}if(v.checkEmptyFrames&&!ie(u)){let h=we(u);h&&N({severity:h.type==="empty"?"error":"warn",type:"empty-frame",message:h.message,id:u.id,nodeName:x})}if(l!==null&&Array.isArray(l)&&l.length>0){if("fills"in u&&Array.isArray(u.fills)&&u.fills.length>0){for(let h of u.fills)if(h.visible!==!1&&h.type==="SOLID"){let S=R(h.color);if(S&&!X(S,l)){N({severity:"error",type:"color",message:`Color ${S} does not follow scale on "${x}". Scale: ${l.join(", ")}`,id:u.id,nodeName:x});break}}}if("strokes"in u&&Array.isArray(u.strokes)&&u.strokes.length>0){for(let h of u.strokes)if(h.visible!==!1&&h.type==="SOLID"){let S=R(h.color);if(S&&!X(S,l)){N({severity:"error",type:"color",message:`Stroke color ${S} does not follow scale on "${x}". Scale: ${l.join(", ")}`,id:u.id,nodeName:x});break}}}if("effects"in u&&Array.isArray(u.effects)&&u.effects.length>0){for(let h of u.effects)if(h.visible!==!1&&(h.type==="DROP_SHADOW"||h.type==="INNER_SHADOW")){let S=R(h.color);if(S&&!X(S,l)){N({severity:"error",type:"color",message:`Effect color ${S} does not follow scale on "${x}". Scale: ${l.join(", ")}`,id:u.id,nodeName:x});break}}}}if(u.type==="TEXT"){let h=u.fontSize;if(h&&typeof h=="number"&&!isNaN(h)&&(h>n||(o!==null?o.includes(Math.round(h))||N({severity:"warn",type:"typography",message:`fontSize ${h}px does not follow scale on text "${u.characters.slice(0,30)}". Scale: ${o.join(", ")}`,id:u.id,nodeName:x}):le(h)||N({severity:"warn",type:"typography",message:`fontSize ${h}px does not follow scale on text "${u.characters.slice(0,30)}". Scale: ${v.allTypographySizes.join(", ")}`,id:u.id,nodeName:x}))),v.requireTextStyleKey){let S=u.textStyleId;if(!S||S===figma.mixed){let I=null;if(f&&f.length>0){let D=ee(u,f,c);D&&D.bestMatch&&(I=D.bestMatch)}let T=u.fontSize&&typeof u.fontSize=="number"?Math.round(u.fontSize):null,L=u.fontName&&typeof u.fontName=="object"?u.fontName.family:null,O=u.fontName&&typeof u.fontName=="object"?u.fontName.style:null,z=null;u.lineHeight&&u.lineHeight.unit==="PERCENT"?z=`${Math.round(u.lineHeight.value)}%`:u.lineHeight&&u.lineHeight.unit==="AUTO"?z="auto":u.lineHeight&&u.lineHeight.unit==="PIXELS"&&T&&(z=`${Math.round(u.lineHeight.value/T*100)}%`);let H=null;u.letterSpacing&&typeof u.letterSpacing=="object"?u.letterSpacing.unit==="PERCENT"?H=`${u.letterSpacing.value}%`:u.letterSpacing.unit==="PIXELS"&&(H=`${u.letterSpacing.value}px`):typeof u.letterSpacing=="number"&&(H=`${u.letterSpacing}`),N({severity:"warn",type:"typography-style",message:"Text does not use Text Style (variable) \u2014 difficult to manage and not consistent. Should create and use Text Style Variable.",id:u.id,nodeName:x,nodeProps:{fontFamily:L,fontSize:T,fontWeight:O,lineHeight:z,letterSpacing:H},bestMatch:I})}}else if(v.allowedTextStyleIds.length>0){let S=u.textStyleId;(!S||!v.allowedTextStyleIds.includes(S))&&N({severity:"warn",type:"typography-style",message:"Text does not use standard Text Style.",id:u.id,nodeName:x})}if(v.disallowLineHeightAuto||v.disallowLineHeightBaseline||a!==null){let S=ye(u,a,s,r);S&&N(S)}if(v.checkTextContrast){let S=ge(u);if(S){S.textColorHex=S.textColor,S.backgroundColorHex=S.backgroundColor;let I=`${S.contrast.toFixed(2)}|${S.textColor}|${S.backgroundColor}|${S.backgroundColorNode}`;b.has(I)||b.set(I,[]),b.get(I).push(S)}}if(v.checkTextSizeMobile){let S=me(u);S&&(u.fontName&&(S.fontName=u.fontName),N(S))}if(f&&f.length>0&&c&&c.checkStyle){let S=ee(u,f,c);S&&!S.matched?N({severity:"error",type:"typography-check",message:S.message,id:u.id,nodeName:x,textPreview:S.textPreview,nodeProps:S.nodeProps,bestMatch:S.bestMatch}):S&&S.matched&&N({severity:"info",type:"typography-check",message:`\u2713 Matches style "${S.styleName}"`,id:u.id,nodeName:x,styleName:S.styleName,nodeProps:S.nodeProps,styleProps:S.styleProps})}}if(v.requireComponentization&&(u.type==="FRAME"||u.type==="COMPONENT"||u.type==="INSTANCE")&&J(u)){let h=u.type==="FRAME"?"Frame":u.type,S=Y(u),I=S&&y.has(S)?y.get(S).length:1;if(I>1&&S&&!w.has(S)){w.add(S);let T=` (used ${I} times)`;N({severity:"warn",type:"component",message:`${h} "${x}" should be componentized for reuse${T}.`,id:u.id,nodeName:x})}}v.checkNegativePosition&&"x"in u&&"y"in u&&u.parent&&u.parent.type!=="PAGE"&&(u.x<-.5||u.y<-.5)&&N({severity:"warn",type:"position",message:`Child has negative position (x:${Math.round(u.x)}, y:${Math.round(u.y)}) in "${u.parent.name}". Check margin/absolute positioning.`,id:u.id,nodeName:x})}catch(x){console.error("Scan node error",x)}if(A.size>0){for(let[u,x]of A.entries())if(x.length>0){let h=x[0],S=x.length,I=h.message;S>1&&(I.includes(`"${h.nodeName}"`)?I=I.replace(`"${h.nodeName}"`,`(${S} nodes)`):I.includes(`'${h.nodeName}'`)?I=I.replace(`'${h.nodeName}'`,`(${S} nodes)`):I=`${I} (${S} nodes)`);let T=Object.assign({},h,{message:I,affectedCount:S});p.push(T)}}if(b.size>0){for(let[u,x]of b.entries())if(x.length>0){let h=x[0],S=x.length,I=h.message;if(S>1){let T=h.contrast.toFixed(2),L=h.isLargeText!==void 0?h.isLargeText:h.fontSize>=18,O=h.minContrast!==void 0?h.minContrast:L?v.contrastAALarge:v.contrastAA;h.isGradient?I=`Text contrast ratio ${T}:1 fails WCAG ${L?"AA (large text)":"AA"} (requires >= ${O}:1) with a gradient background (${S} text nodes). Manual check recommended because gradients may pass at some positions.`:Math.abs(h.contrast-1)<.01?I=`Text contrast ratio ${T}:1 \u2014 background color may not have been detected correctly (e.g. a sibling layer behind the text) (${S} text nodes). Manual check recommended.`:I=`Text contrast ratio ${T}:1 fails WCAG ${L?"AA (large text)":"AA"} (requires >= ${O}:1) (${S} text nodes).`}p.push({severity:h.severity,type:"contrast",message:I,id:h.id,nodeName:h.nodeName,contrast:h.contrast,fontSize:h.fontSize,isLargeText:h.isLargeText,minContrast:h.minContrast,textColor:h.textColor,textColorNode:h.textColorNode,backgroundColor:h.backgroundColor,backgroundColorNode:h.backgroundColorNode,isGradient:h.isGradient,gradientType:h.gradientType,gradientString:h.gradientString,fromSibling:h.fromSibling,affectedCount:S})}}if(v.checkDuplicateFrames){for(let[u,x]of y.entries())if(x.length>1&&!w.has(u)){let h=x.filter(S=>!ne(S));if(h.length>1&&!h.some(I=>v.requireComponentization&&(I.type==="FRAME"||I.type==="COMPONENT"||I.type==="INSTANCE")&&J(I))){w.add(u);let I=h[0];p.push({severity:"warn",type:"duplicate",message:`Possible duplicate ${I.type.toLowerCase()} "${I.name||"Unnamed"}" (${h.length} copies) \u2014 n\xEAn component h\xF3a.`,id:I.id,nodeName:I.name||"Unnamed"})}}}return p}function R(t,e=1){if(!t)return null;let i=Math.round(t.r*255),l=Math.round(t.g*255),o=Math.round(t.b*255);return`#${i.toString(16).padStart(2,"0")}${l.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}`.toUpperCase()}function B(t){if(!t||t.type==="SOLID")return null;if(t.type==="GRADIENT_LINEAR"||t.type==="GRADIENT_RADIAL"||t.type==="GRADIENT_ANGULAR"||t.type==="GRADIENT_DIAMOND"){let e=t.gradientStops.map(o=>{let n=R(o.color),a=(o.position*100).toFixed(2);return`${n} ${a}%`}).join(", "),l=`${t.type.replace("GRADIENT_","").toLowerCase()}-gradient(`;if(t.type==="GRADIENT_RADIAL"){if(t.gradientHandlePositions&&t.gradientHandlePositions.length>=3){let o=t.gradientHandlePositions,n=o[0],a=o[1],s=o[2],r=a.x-n.x,f=a.y-n.y,c=s.x-n.x,d=s.y-n.y,p=(Math.sqrt(c*c+d*d)*100).toFixed(2),y=(Math.sqrt(r*r+f*f)*100).toFixed(2),g=(n.x*100).toFixed(2),m=(n.y*100).toFixed(2);l+=`${p}% ${y}% at ${g}% ${m}%, `}else if(t.gradientTransform){let o=t.gradientTransform;if(o&&o.length>=2){let n=Math.sqrt(o[0][0]*o[0][0]+o[0][1]*o[0][1]),a=Math.sqrt(o[1][0]*o[1][0]+o[1][1]*o[1][1]),s=(n*100).toFixed(2),r=(a*100).toFixed(2),f=(o[0][2]*100).toFixed(2),c=(o[1][2]*100).toFixed(2);l+=`${s}% ${r}% at ${f}% ${c}%, `}}}else t.type==="GRADIENT_LINEAR"&&t.gradientHandlePositions&&t.gradientHandlePositions.length>=2;return l+=e+")",l}return null}function Ee(t){if(!t.lineHeight)return null;if(t.lineHeight.unit==="AUTO")return"auto";if(t.lineHeight.unit==="PERCENT")return`${Math.round(t.lineHeight.value)}%`;if(t.lineHeight.unit==="PIXELS"&&t.fontSize&&typeof t.fontSize=="number"&&!isNaN(t.fontSize)){let e=t.lineHeight.value/t.fontSize*100;return`${Math.round(e)}%`}return null}function G(t,e){e=e||{};let i=typeof e.maxNodesPerToken=="number"?e.maxNodesPerToken:25,l=typeof e.maxTotalNodeRefs=="number"?e.maxTotalNodeRefs:4e3,o=typeof e.sampleNodesWhenOverLimit=="number"?e.sampleNodesWhenOverLimit:3;if(!t||typeof t!="object")return t;let n=["colors","gradients","spacing","borderRadius","fontWeight","lineHeight","fontSize","fontFamily"],a=0,s=0;for(let r of n){let f=Array.isArray(t[r])?t[r]:[];for(let c of f){let d=Array.isArray(c.nodes)?c.nodes:[],p=typeof c.totalNodes=="number"?c.totalNodes:d.length;c.totalNodes=p,a+=p,d.length>i&&(c.nodes=d.slice(0,i),c.nodesTruncated=!0),s+=Array.isArray(c.nodes)?c.nodes.length:0}}if(a>l){for(let r of n){let f=Array.isArray(t[r])?t[r]:[];for(let c of f){let d=Array.isArray(c.nodes)?c.nodes:[];d.length>o&&(c.nodes=d.slice(0,o),c.nodesTruncated=!0)}}s=0;for(let r of n){let f=Array.isArray(t[r])?t[r]:[];for(let c of f)s+=Array.isArray(c.nodes)?c.nodes.length:0}}return t._meta={totalNodeRefs:a,sentNodeRefs:s,maxNodesPerToken:i,maxTotalNodeRefs:l,truncated:s<a},t}function Ie(t){if(!t||typeof t!="object")return t;let e=Object.assign({},t);return Array.isArray(e.issues)&&e.issues.length>1500&&(e.issues=e.issues.slice(0,1500),e.totalIssues=typeof e.totalIssues=="number"?e.totalIssues:t.issues.length,e._truncated=!0),e.tokens&&typeof e.tokens=="object"&&(e.tokens=G(e.tokens,{maxNodesPerToken:10,maxTotalNodeRefs:2e3})),e}function Ae(t){if(!t||typeof t!="object")return t;let e=Object.assign({},t);if(e.data&&typeof e.data=="object"){let i=Object.assign({},e.data);i.issues=Array.isArray(i.issues)?i.issues.slice(0,1500):i.issues||null,i.tokens=i.tokens&&typeof i.tokens=="object"?G(i.tokens,{maxNodesPerToken:10,maxTotalNodeRefs:2e3}):i.tokens||null,e.data=i}return e}async function Me(t){let e=[];if(t==="selection")if(figma.currentPage.selection.length===0)figma.notify("No selection \u2014 scanning the whole page."),P(figma.currentPage,c=>e.push(c));else for(let c of figma.currentPage.selection)P(c,d=>e.push(d));else P(figma.currentPage,c=>e.push(c));let i=e.length,l=0,o=Math.max(1,Math.floor(i/50)),n={colors:new Map,gradients:new Map,spacing:new Map,borderRadius:new Map,fontWeight:new Map,lineHeight:new Map,fontSize:new Map,fontFamily:new Map};function a(c,d,p,y,g=null,m=null){let w=String(d);c.has(w)||c.set(w,{value:d,nodes:[],colorType:g||null});let b=c.get(w),A=b.nodes.find(N=>N.id===p);if(A){if(m&&typeof m=="object")for(let[N,E]of Object.entries(m))E!=null&&E!==""&&A[N]!==E&&(A[N]=E)}else{let N={id:p,name:y||"Unnamed"};m&&typeof m=="object"&&Object.assign(N,m),b.nodes.push(N)}g&&!b.colorType?b.colorType=g:g&&b.colorType&&b.colorType!==g&&(b.colorType.includes(g)||(b.colorType=`${b.colorType}, ${g}`))}for(let c of e)try{if(F)throw figma.notify("Extraction cancelled by user"),F=!1,new Error("Extraction cancelled");if(l++,l%o===0||l===i){let y=Math.round(l/i*100);figma.ui.postMessage({type:"scan-progress",progress:y,current:l,total:i}),await new Promise(g=>setTimeout(g,0))}if("visible"in c&&c.visible===!1)continue;let d=c.id,p=c.name||"Unnamed";if((c.type==="FRAME"||c.type==="COMPONENT"||c.type==="INSTANCE")&&c.layoutMode&&c.layoutMode!=="NONE"){typeof c.itemSpacing=="number"&&!isNaN(c.itemSpacing)&&a(n.spacing,Math.abs(Math.round(c.itemSpacing)),d,p,null,{spacingType:"itemSpacing"});let y=[{k:"paddingLeft",v:c.paddingLeft},{k:"paddingRight",v:c.paddingRight},{k:"paddingTop",v:c.paddingTop},{k:"paddingBottom",v:c.paddingBottom}];for(let g of y)typeof g.v=="number"&&!isNaN(g.v)&&a(n.spacing,Math.abs(Math.round(g.v)),d,p,null,{spacingType:g.k})}if("fills"in c&&Array.isArray(c.fills)&&c.fills.length>0){let y="background";c.type==="TEXT"?y="text":c.type==="FRAME"||c.type==="COMPONENT"||c.type==="INSTANCE"||c.type==="GROUP"?y="background":y="fill";for(let g of c.fills)if(g.type==="SOLID"){let m=R(g.color);m&&a(n.colors,m,d,p,y)}else if(g.type==="GRADIENT_LINEAR"||g.type==="GRADIENT_RADIAL"||g.type==="GRADIENT_ANGULAR"||g.type==="GRADIENT_DIAMOND"){let m=B(g);m&&a(n.gradients,m,d,p,y)}}if("strokes"in c&&Array.isArray(c.strokes)&&c.strokes.length>0){for(let y of c.strokes)if(y.type==="SOLID"){let g=R(y.color);g&&a(n.colors,g,d,p,"border")}}if("effects"in c&&Array.isArray(c.effects)&&c.effects.length>0){for(let y of c.effects)if(y.type==="DROP_SHADOW"||y.type==="INNER_SHADOW"){let g=R(y.color);g&&a(n.colors,g,d,p,"shadow")}}if("cornerRadius"in c&&typeof c.cornerRadius=="number"){let y=Math.round(c.cornerRadius);a(n.borderRadius,y,d,p)}if("topLeftRadius"in c&&typeof c.topLeftRadius=="number"){let y=Math.round(c.topLeftRadius);a(n.borderRadius,y,d,p)}if("topRightRadius"in c&&typeof c.topRightRadius=="number"){let y=Math.round(c.topRightRadius);a(n.borderRadius,y,d,p)}if("bottomLeftRadius"in c&&typeof c.bottomLeftRadius=="number"){let y=Math.round(c.bottomLeftRadius);a(n.borderRadius,y,d,p)}if("bottomRightRadius"in c&&typeof c.bottomRightRadius=="number"){let y=Math.round(c.bottomRightRadius);a(n.borderRadius,y,d,p)}if(c.type==="TEXT"){if(c.fontSize&&typeof c.fontSize=="number"){let g=Math.round(c.fontSize);a(n.fontSize,g,d,p)}if(c.fontName&&typeof c.fontName=="object"){let g=c.fontName.family||"",m=c.fontName.style||"";if(g){let w=m?`${g} (${m})`:g;a(n.fontFamily,w,d,p)}}if(c.fontName&&typeof c.fontName=="object"){let g=c.fontName.family||"",m=c.fontName.style||"";m&&a(n.fontWeight,m,d,p,null,{fontFamily:g||"Unknown"})}let y=Ee(c);y&&a(n.lineHeight,y,d,p)}}catch(d){console.error("Extract token error",d)}function s(c,d){return Array.from(c.values()).sort((p,y)=>d?d(p.value,y.value):typeof p.value=="number"&&typeof y.value=="number"?y.value-p.value:String(p.value).localeCompare(String(y.value)))}function r(c){if(!Array.isArray(c))return c;for(let d of c){let p=Array.isArray(d.nodes)?d.nodes:[],y=new Map;for(let g of p){let m=g&&g.fontFamily?String(g.fontFamily):"Unknown";y.set(m,(y.get(m)||0)+1)}d.fontFamilies=Array.from(y.entries()).map(([g,m])=>({family:g,count:m})).sort((g,m)=>m.count-g.count||g.family.localeCompare(m.family))}return c}let f={colors:s(n.colors),gradients:s(n.gradients),spacing:s(n.spacing,(c,d)=>c-d),borderRadius:s(n.borderRadius,(c,d)=>c-d),fontWeight:s(n.fontWeight),lineHeight:s(n.lineHeight),fontSize:s(n.fontSize,(c,d)=>d-c),fontFamily:s(n.fontFamily)};return f.fontWeight=r(f.fontWeight),G(f)}async function te(t,e){if(t.type!=="TEXT")throw new Error("Node is not a text node");let i=t.fontName,l=i?i.family:"Inter",o=i?i.style:"Regular",n={fontFamily:null,fontWeight:null,fontSize:null,lineHeight:null,letterSpacing:null};if(e.differences)for(let r of e.differences)!r.matches&&r.expected&&(r.property==="Font Family"?n.fontFamily=r.expected:r.property==="Font Weight"?n.fontWeight=r.expected:r.property==="Font Size"?n.fontSize=r.expected:r.property==="Line Height"?n.lineHeight=r.expected:r.property==="Letter Spacing"&&(n.letterSpacing=r.expected));let a=l,s=o;if(n.fontFamily){a=n.fontFamily;try{await figma.loadFontAsync({family:a,style:s}),t.fontName={family:a,style:s}}catch(r){try{await figma.loadFontAsync({family:a,style:"Regular"}),t.fontName={family:a,style:"Regular"},s="Regular"}catch(f){throw console.error(`Failed to load font ${a}:`,f),new Error(`Font "${a}" not available. Please install it first.`)}}}if(n.fontWeight){let f={Regular:"Regular",Medium:"Medium","Semi Bold":"SemiBold",SemiBold:"SemiBold",Bold:"Bold"}[n.fontWeight]||n.fontWeight;if(f!==s)try{await figma.loadFontAsync({family:a,style:f}),t.fontName={family:a,style:f},s=f}catch(c){console.error(`Failed to load font style ${a} ${f}:`,c),console.warn(`Using current style ${s} instead of ${f}`)}}try{await figma.loadFontAsync({family:a,style:s}),(!t.fontName||t.fontName.family!==a||t.fontName.style!==s)&&(t.fontName={family:a,style:s})}catch(r){throw console.error("Failed to ensure font is loaded:",r),new Error(`Cannot load font "${a}" ${s}. Please ensure the font is installed.`)}if(n.fontSize){let r=parseFloat(n.fontSize.replace("px",""));if(!isNaN(r)&&r>0&&r<=1e3)try{t.fontSize=r}catch(f){throw console.error("Failed to set font size:",f),new Error(`Cannot set font size to ${r}px: ${f.message}`)}}if(n.lineHeight)try{let r=n.lineHeight;if(r==="auto")t.lineHeight={unit:"AUTO"};else if(r.includes("%")){let f=parseFloat(r.replace("%",""));isNaN(f)||(t.lineHeight={unit:"PERCENT",value:f})}else{let f=parseFloat(r.replace("px",""));isNaN(f)||(t.lineHeight={unit:"PIXELS",value:f})}}catch(r){if(r.message&&r.message.includes("unloaded"))try{await figma.loadFontAsync({family:a,style:s}),t.fontName={family:a,style:s};let f=n.lineHeight;if(f==="auto")t.lineHeight={unit:"AUTO"};else if(f.includes("%")){let c=parseFloat(f.replace("%",""));isNaN(c)||(t.lineHeight={unit:"PERCENT",value:c})}else{let c=parseFloat(f.replace("px",""));isNaN(c)||(t.lineHeight={unit:"PIXELS",value:c})}}catch(f){throw new Error(`Cannot set line height: Font "${a}" ${s} is not loaded. ${f.message}`)}else throw r}if(n.letterSpacing)try{let r=n.letterSpacing;if(r.includes("%")){let f=parseFloat(r.replace("%",""));isNaN(f)||(t.letterSpacing={unit:"PERCENT",value:f})}else{let f=parseFloat(r.replace("px",""));isNaN(f)||(t.letterSpacing={unit:"PIXELS",value:f})}}catch(r){if(r.message&&r.message.includes("unloaded"))try{await figma.loadFontAsync({family:a,style:s}),t.fontName={family:a,style:s};let f=n.letterSpacing;if(f.includes("%")){let c=parseFloat(f.replace("%",""));isNaN(c)||(t.letterSpacing={unit:"PERCENT",value:c})}else{let c=parseFloat(f.replace("px",""));isNaN(c)||(t.letterSpacing={unit:"PIXELS",value:c})}}catch(f){throw new Error(`Cannot set letter spacing: Font "${a}" ${s} is not loaded. ${f.message}`)}else throw r}}figma.ui.onmessage=async t=>{switch(t.type){case"notify":{let e=t.message||"Notification";figma.notify(e);break}case"cancel-scan":{F=!0,figma.notify("Cancelling scan...");break}case"scan":{F=!1;let e=t.mode||"page",i=V(e),l=t.spacingScale||"",o=t.spacingThreshold||100,n=t.colorScale||"",a=t.fontSizeScale||"",s=t.fontSizeThreshold||100,r=t.lineHeightScale||"",f=t.lineHeightThreshold||300,c=t.lineHeightBaselineThreshold||120,d=t.typographyStyles||[],p=t.typographyRules||{},y=t.ignoredIssues||{},g=null;if(l.trim())try{let N=l.split(",").map(E=>{let M=parseInt(E.trim(),10);return isNaN(M)?null:M}).filter(E=>E!==null);N.length>0&&(g=N)}catch(N){console.error("Error parsing spacing guidelines:",N)}let m=null;if(n.trim())try{let N=n.split(",").map(E=>{let M=E.trim();return M?j(M):null}).filter(E=>E!==null);N.length>0&&(m=N)}catch(N){console.error("Error parsing color:",N)}let w=null;if(a.trim())try{let N=a.split(",").map(E=>{let M=parseInt(E.trim(),10);return isNaN(M)?null:M}).filter(E=>E!==null);N.length>0&&(w=N)}catch(N){console.error("Error parsing font-size scale:",N)}let b=null,A=!1;if(r.trim())try{A=r.toLowerCase().includes("auto");let E=r.split(",").map(M=>{let k=M.trim().toLowerCase();if(k==="auto")return null;let u=parseInt(k,10);return isNaN(u)?null:u}).filter(M=>M!==null);(E.length>0||A)&&(b={values:E,allowAuto:A})}catch(N){console.error("Error parsing line-height scale:",N)}try{let N=await be(e,g,o,m,w,s,b,f,c,d,p);y&&typeof y=="object"&&N.forEach(k=>{y[k.id]===!0&&(k.ignored=!0,k.severity="info")});let E=3e3,M=N.slice(0,E);N.length>E&&figma.notify(`\u26A0\uFE0F Found ${N.length} issues, but only showing first ${E} to prevent memory errors.`),figma.ui.postMessage({type:"report",issues:M,context:i,totalIssues:N.length})}catch(N){figma.notify(`Scan failed: ${N.message}`),figma.ui.postMessage({type:"report",issues:[],error:N.message,context:i})}break}case"extract-tokens":{F=!1;let e=t.mode||"page",i=V(e);try{let l=await Me(e),o=G(l);figma.ui.postMessage({type:"tokens-report",tokens:o,context:i})}catch(l){figma.notify(`Token extraction failed: ${l.message}`),figma.ui.postMessage({type:"tokens-report",tokens:null,error:l.message,context:i})}break}case"select-node":{let e=t.id,i=figma.getNodeById(e);if(i){figma.currentPage.selection=[i];let l=200,o;if("absoluteBoundingBox"in i&&i.absoluteBoundingBox)o=i.absoluteBoundingBox;else if("x"in i&&"y"in i&&"width"in i&&"height"in i){let y=i.x,g=i.y,m=i.parent;for(;m&&"x"in m&&"y"in m&&m.type!=="PAGE";)y+=m.x,g+=m.y,m=m.parent;o={x:y,y:g,width:i.width,height:i.height}}else{figma.viewport.scrollAndZoomIntoView([i]),figma.notify("Node selected");return}let n={x:o.x-l,y:o.y-l,width:o.width+l*2,height:o.height+l*2},a=n.x+n.width/2,s=n.y+n.height/2,r=figma.viewport.bounds.width,f=figma.viewport.bounds.height,c=r/n.width,d=f/n.height,p=Math.min(c,d,2);figma.viewport.center={x:a,y:s},figma.viewport.zoom=p,figma.notify("Node selected and centered in the viewport")}else figma.notify("Node not found");break}case"save-last-report":{try{await figma.clientStorage.setAsync(C.lastReport,Ie(t.report||null))}catch(e){console.error("Failed to save last report",e)}break}case"get-last-report":{try{let e=await figma.clientStorage.getAsync(C.lastReport);figma.ui.postMessage({type:"last-report",report:e||null})}catch(e){console.error("Failed to load last report",e),figma.ui.postMessage({type:"last-report",report:null})}break}case"save-history-entry":{try{let e=Ae(t.entry);if(e){let i=await figma.clientStorage.getAsync(C.history)||[];i.unshift(e),i=i.slice(0,re),await figma.clientStorage.setAsync(C.history,i),figma.ui.postMessage({type:"history-data",history:i})}}catch(e){console.error("Failed to save history entry",e)}break}case"get-history":{try{let e=await figma.clientStorage.getAsync(C.history)||[];figma.ui.postMessage({type:"history-data",history:e})}catch(e){console.error("Failed to load history",e),figma.ui.postMessage({type:"history-data",history:[]})}break}case"save-input-values":{try{await figma.clientStorage.setAsync(C.inputValues,t.values||null)}catch(e){console.error("Failed to save input values",e)}break}case"get-input-values":{try{let e=await figma.clientStorage.getAsync(C.inputValues);figma.ui.postMessage({type:"input-values-data",values:e||null})}catch(e){console.error("Failed to load input values",e),figma.ui.postMessage({type:"input-values-data",values:null})}break}case"clear-history":{try{await figma.clientStorage.deleteAsync(C.history),await figma.clientStorage.deleteAsync(C.lastReport),await figma.clientStorage.deleteAsync(C.inputValues),figma.ui.postMessage({type:"history-data",history:[]}),figma.notify("\u2705 History and settings cleared")}catch(e){console.error("Error clearing history:",e)}break}case"extract-typography-styles":{try{let e=t.mode||"all",i=figma.getLocalTextStyles(),l=[];for(let n of i){let a=n.name.toLowerCase(),s=a.includes("mobile")||a.includes("mob")||a.includes("m/")||a.endsWith("/m"),r=a.includes("tablet")||a.includes("tab")||a.includes("t/")||a.endsWith("/t");if(e==="desktop"){if(s||r)continue}else if(e==="tablet"){if(!r)continue}else if(e==="mobile"&&!s)continue;let f=n.fontName&&n.fontName.family?n.fontName.family:"Inter",c=n.fontName&&n.fontName.style?n.fontName.style:"Regular",d=typeof n.fontSize=="number"?Math.round(n.fontSize):16,p="150%";n.lineHeight&&n.lineHeight.unit==="PERCENT"?p=Math.round(n.lineHeight.value)+"%":n.lineHeight&&n.lineHeight.unit==="AUTO"?p="auto":n.lineHeight&&n.lineHeight.unit==="PIXELS"&&d&&(p=Math.round(n.lineHeight.value/d*100)+"%");let y="0";n.letterSpacing&&n.letterSpacing.unit==="PIXELS"?y=String(Math.round(n.letterSpacing.value*100)/100):n.letterSpacing&&n.letterSpacing.unit==="PERCENT"&&(y=String(Math.round(n.letterSpacing.value*10)/10)+"%"),l.push({name:n.name,styleId:n.id,fontFamily:f,fontSize:d,fontWeight:c,lineHeight:p,letterSpacing:y,wordSpacing:"0"})}let o=e==="desktop"?"Desktop":e==="tablet"?"Tablet":e==="mobile"?"Mobile":"All";figma.ui.postMessage({type:"typography-styles-extracted",styles:l,mode:e}),l.length===0?figma.notify(`\u26A0\uFE0F No ${o.toLowerCase()} text styles found`):figma.notify(`\u2705 Extracted ${l.length} ${o.toLowerCase()} text styles`)}catch(e){figma.notify(`\u274C Error extracting text styles: ${e.message}`),console.error("Error extracting text styles:",e)}break}case"select-text-style":{try{let l=function(n,a){if(n.type==="TEXT"&&n.textStyleId===a)return n;if("children"in n)for(let s of n.children){let r=l(s,a);if(r)return r}return null},e=t.styleId;if(!e){figma.notify("\u26A0\uFE0F No style ID provided");break}let i=figma.getStyleById(e);if(!i||i.type!=="TEXT"){figma.notify("\u26A0\uFE0F Text style not found");break}let o=l(figma.currentPage,e);o?(figma.currentPage.selection=[o],figma.viewport.scrollAndZoomIntoView([o]),figma.notify(`\u2705 Selected "${o.characters.slice(0,30)}..." with style "${i.name}"`)):figma.notify(`\u26A0\uFE0F No text using style "${i.name}" found on this page`)}catch(e){figma.notify(`\u274C Error: ${e.message}`),console.error("Error selecting text style:",e)}break}case"fix-issue":{let e=t.issue,i=e?e.id:null;try{if(!e)throw new Error("No issue provided");let l=e.id,o=figma.getNodeById(l);if(!o){figma.notify("\u26A0\uFE0F Node not found"),figma.ui.postMessage({type:"fix-issue-result",issueId:i,success:!1,message:"\u26A0\uFE0F Node not found"});break}try{if(o.type==="TEXT"){let n=o.fontSize;if(o.parent&&"locked"in o.parent&&o.parent.locked)throw new Error("Node is locked")}}catch(n){figma.notify("\u26A0\uFE0F Cannot fix: Node is in read-only mode. Please switch to Design Mode or unlock the node."),figma.ui.postMessage({type:"fix-issue-result",issueId:i,success:!1,message:"\u26A0\uFE0F Cannot fix: Node is in read-only mode. Please switch to Design Mode."});break}if(e.type==="typography-check"&&e.bestMatch)if(t.fixData){let n=t.fixData,a=n.fontFamily||"Inter",s=n.fontWeight||"Regular";try{await figma.loadFontAsync({family:a,style:s})}catch(r){try{await figma.loadFontAsync({family:a,style:"Regular"})}catch(f){throw new Error(`Font "${a}" could not be loaded. Please ensure it's installed.`)}}if(o.fontName={family:a,style:s},o.fontSize=parseFloat(n.fontSize)||16,n.lineHeight==="auto")o.lineHeight={unit:"AUTO"};else if(n.lineHeight.includes("%")){let r=parseFloat(n.lineHeight.replace("%",""));isNaN(r)||(o.lineHeight={unit:"PERCENT",value:r})}else if(n.lineHeight.includes("px")){let r=parseFloat(n.lineHeight.replace("px",""));isNaN(r)||(o.lineHeight={unit:"PIXELS",value:r})}if(n.letterSpacing&&n.letterSpacing!=="0"){if(n.letterSpacing.includes("%")){let r=parseFloat(n.letterSpacing.replace("%",""));isNaN(r)||(o.letterSpacing={unit:"PERCENT",value:r})}else if(n.letterSpacing.includes("px")){let r=parseFloat(n.letterSpacing.replace("px",""));isNaN(r)||(o.letterSpacing={unit:"PIXELS",value:r})}}figma.notify("\u2705 Fixed typography with custom values"),figma.ui.postMessage({type:"fix-issue-result",issueId:i,success:!0,message:"\u2705 Fixed typography with custom values"})}else await te(o,e.bestMatch),figma.notify(`\u2705 Fixed typography to match "${e.bestMatch.name}"`),figma.ui.postMessage({type:"fix-issue-result",issueId:i,success:!0,message:`\u2705 Fixed typography to match "${e.bestMatch.name}"`});else t.manualFix?(figma.notify(`\u26A0\uFE0F Manual fix required: ${t.manualFix}`),figma.ui.postMessage({type:"fix-issue-result",issueId:i,success:!1,message:`\u26A0\uFE0F Manual fix required: ${t.manualFix}`})):(figma.notify("\u26A0\uFE0F Cannot auto-fix this issue type"),figma.ui.postMessage({type:"fix-issue-result",issueId:i,success:!1,message:"\u26A0\uFE0F Cannot auto-fix this issue type"}))}catch(l){figma.notify(`\u274C Error fixing issue: ${l.message}`),console.error("Error fixing issue:",l),figma.ui.postMessage({type:"fix-issue-result",issueId:i,success:!1,message:`\u274C Error: ${l.message}`})}break}case"fix-all-issues":{try{let e=t.issues||[],i=t.issueType||"unknown",l=0,o=0;for(let n of e)try{let a=n.id,s=figma.getNodeById(a);if(!s){o++;continue}try{if(s.type==="TEXT"){let r=s.fontSize;if(s.parent&&"locked"in s.parent&&s.parent.locked)throw new Error("Node is locked")}}catch(r){o++;continue}n.type==="typography-check"&&n.bestMatch&&(await te(s,n.bestMatch),l++)}catch(a){console.error("Error fixing issue:",a),o++}if(l>0){let n=o>0?` (${o} failed - may be in read-only mode)`:"";figma.notify(`\u2705 Fixed ${l} issue(s) in ${i}${n}`)}else figma.notify(`\u26A0\uFE0F No issues could be fixed. ${o>0?"Nodes may be in read-only mode. Please switch to Design Mode.":""}`)}catch(e){figma.notify(`\u274C Error fixing issues: ${e.message}`),console.error("Error fixing all issues:",e)}break}case"create-text-style":{console.log("create-text-style handler called",t);let e=t.issue,i=e?e.id:null,l=t.styleName;try{if(!e||!e.id)throw new Error("Invalid issue data");if(!l||!l.trim())throw new Error("Style name is required");let o=e.id,n=figma.getNodeById(o);if(console.log("create-text-style: node found",{nodeId:o,nodeType:n?n.type:"null"}),!n){figma.notify("\u26A0\uFE0F Node not found"),figma.ui.postMessage({type:"create-text-style-result",issueId:i,success:!1,message:"\u26A0\uFE0F Node not found"});break}if(n.type!=="TEXT"){figma.notify("\u26A0\uFE0F Node is not a text node"),figma.ui.postMessage({type:"create-text-style-result",issueId:i,success:!1,message:"\u26A0\uFE0F Node is not a text node"});break}let a=n.fontName,s=n.fontSize,r=n.lineHeight,f=n.letterSpacing;if(!a||typeof a!="object"||!a.family)throw new Error("Font information is missing or invalid");let c=a.family,d=a.style||"Regular",p=a,g={"Semi Bold":"SemiBold",SemiBold:"SemiBold","Semi-Bold":"SemiBold",Semi:"SemiBold"}[d]||d;try{await figma.loadFontAsync(a)}catch(w){if(g!==d)try{console.warn(`Font style "${c} ${d}" not available, trying "${g}"...`),await figma.loadFontAsync({family:c,style:g}),p={family:c,style:g}}catch(b){try{console.warn(`Font style "${c} ${g}" not available, trying Regular...`),await figma.loadFontAsync({family:c,style:"Regular"}),p={family:c,style:"Regular"}}catch(A){let N=A&&A.message?A.message:`Font "${c}" could not be loaded`;throw new Error(`${N}. Please ensure the font "${c}" is installed in Figma.`)}}else try{console.warn(`Font style "${c} ${d}" not available, trying Regular...`),await figma.loadFontAsync({family:c,style:"Regular"}),p={family:c,style:"Regular"}}catch(b){let A=b&&b.message?b.message:`Font "${c}" could not be loaded`;throw new Error(`${A}. Please ensure the font "${c}" is installed in Figma.`)}}let m=figma.createTextStyle();m.name=l.trim(),m.fontName=p,m.fontSize=s,m.lineHeight=r,m.letterSpacing=f,n.textStyleId=m.id,figma.notify(`\u2705 Created and applied text style "${l.trim()}"`),figma.ui.postMessage({type:"create-text-style-result",issueId:i,success:!0,message:`\u2705 Created and applied text style "${l.trim()}"`})}catch(o){let n=o&&o.message?o.message:"Unknown error occurred";figma.notify(`\u274C Error creating text style: ${n}`),console.error("Error creating text style:",o),figma.ui.postMessage({type:"create-text-style-result",issueId:i,success:!1,message:`\u274C Error: ${n}`})}break}case"create-text-style-all":{try{let e=t.issues||[],i=t.styleName,l=0,o=0,n=new Map;for(let s of e){let r=s?s.id:null;try{if(!s||!s.id){o++;continue}let f=s.id,c=figma.getNodeById(f);if(!c||c.type!=="TEXT"){o++,figma.ui.postMessage({type:"create-text-style-result",issueId:r,success:!1,message:"\u26A0\uFE0F Node is not a text node"});continue}let d=c.fontName,p=c.fontSize,y=c.lineHeight,g=c.letterSpacing;if(!d||typeof d!="object"||!d.family)throw new Error("Font information is missing or invalid");let m=JSON.stringify({family:d.family,style:d.style,fontSize:p,lineHeight:y?JSON.stringify(y):null,letterSpacing:g?JSON.stringify(g):null}),w=n.get(m);if(!w){let b=d.family,A=d.style||"Regular",N=d,E={"Semi Bold":"SemiBold",SemiBold:"SemiBold","Semi-Bold":"SemiBold",Semi:"SemiBold"},M=E[A]||A;try{await figma.loadFontAsync(d)}catch(u){if(M!==A)try{console.warn(`Font style "${b} ${A}" not available, trying "${M}"...`),await figma.loadFontAsync({family:b,style:M}),N={family:b,style:M}}catch(x){try{console.warn(`Font style "${b} ${M}" not available, trying Regular...`),await figma.loadFontAsync({family:b,style:"Regular"}),N={family:b,style:"Regular"}}catch(h){let S=h&&h.message?h.message:`Font "${b}" could not be loaded`;throw new Error(`${S}. Please ensure the font "${b}" is installed in Figma.`)}}else try{console.warn(`Font style "${b} ${A}" not available, trying Regular...`),await figma.loadFontAsync({family:b,style:"Regular"}),N={family:b,style:"Regular"}}catch(x){let h=x&&x.message?x.message:`Font "${b}" could not be loaded`;throw new Error(`${h}. Please ensure the font "${b}" is installed in Figma.`)}}w=figma.createTextStyle();let k=E.size>0?`${i.trim()} ${E.size+1}`:i.trim();w.name=k,w.fontName=N,w.fontSize=p,w.lineHeight=y,w.letterSpacing=g,E.set(m,w)}c.textStyleId=w.id,l++,figma.ui.postMessage({type:"create-text-style-result",issueId:r,success:!0,message:`\u2705 Applied text style "${w.name}"`})}catch(f){console.error("Error creating text style for node:",f),o++;let c=f&&f.message?f.message:"Unknown error occurred";figma.ui.postMessage({type:"create-text-style-result",issueId:r,success:!1,message:`\u274C Error: ${c}`})}}let a=n.size;if(l>0){let s=a>1?`${a} text styles`:`text style "${i.trim()}"`;figma.notify(`\u2705 Created ${s} and applied to ${l} node(s)${o>0?` (${o} failed)`:""}`)}else figma.notify(`\u26A0\uFE0F No text styles could be created (${o} errors)`)}catch(e){let i=e&&e.message?e.message:"Unknown error occurred";figma.notify(`\u274C Error creating text styles: ${i}`),console.error("Error creating text styles:",e)}break}case"apply-typography-style":{try{let e=t.issue,i=t.style,l=e?e.id:null;if(!e||!e.id)throw new Error("Invalid issue data");if(!i)throw new Error("Style data is required");let o=e.id,n=figma.getNodeById(o);if(!n||n.type!=="TEXT"){figma.notify("\u26A0\uFE0F Node is not a text node"),figma.ui.postMessage({type:"apply-typography-style-result",issueId:l,success:!1,message:"\u26A0\uFE0F Node is not a text node"});break}let a=i.fontFamily||"Inter",s=i.fontSize||16,r=i.fontWeight||"Regular",f=i.lineHeight||"150%",c=i.letterSpacing||"0",p={Regular:"Regular",Medium:"Medium","Semi Bold":"SemiBold",SemiBold:"SemiBold",Bold:"Bold"}[r]||r;try{await figma.loadFontAsync({family:a,style:p})}catch(y){try{await figma.loadFontAsync({family:a,style:"Regular"})}catch(g){throw new Error(`Font "${a}" could not be loaded. Please ensure it's installed.`)}}if(n.fontName={family:a,style:p},n.fontSize=s,f==="auto")n.lineHeight={unit:"AUTO"};else if(f.includes("%")){let y=parseFloat(f.replace("%",""));isNaN(y)||(n.lineHeight={unit:"PERCENT",value:y})}else{let y=parseFloat(f.replace("px",""));isNaN(y)||(n.lineHeight={unit:"PIXELS",value:y})}if(c&&c!=="0")if(c.includes("%")){let y=parseFloat(c.replace("%",""));isNaN(y)||(n.letterSpacing={unit:"PERCENT",value:y})}else{let y=parseFloat(c.replace("px",""));isNaN(y)||(n.letterSpacing={unit:"PIXELS",value:y})}figma.notify(`\u2705 Applied typography style "${i.name}"`),figma.ui.postMessage({type:"apply-typography-style-result",issueId:l,success:!0,message:`\u2705 Applied typography style "${i.name}"`})}catch(e){let i=e&&e.message?e.message:"Unknown error occurred";figma.notify(`\u274C Error applying style: ${i}`),console.error("Error applying typography style:",e),figma.ui.postMessage({type:"apply-typography-style-result",issueId,success:!1,message:`\u274C Error: ${i}`})}break}case"get-figma-text-styles":{try{let e=figma.getLocalTextStyles(),i=[];for(let l of e)i.push({id:l.id,name:l.name,fontFamily:l.fontName?l.fontName.family:"Inter",fontWeight:l.fontName?l.fontName.style:"Regular",fontSize:typeof l.fontSize=="number"?Math.round(l.fontSize):16,lineHeight:l.lineHeight?l.lineHeight.unit==="PERCENT"?`${Math.round(l.lineHeight.value)}%`:l.lineHeight.unit==="AUTO"?"auto":l.lineHeight.unit==="PIXELS"&&l.fontSize?`${Math.round(l.lineHeight.value/l.fontSize*100)}%`:"150%":"150%",letterSpacing:l.letterSpacing?l.letterSpacing.unit==="PIXELS"?`${Math.round(l.letterSpacing.value*100)/100}px`:l.letterSpacing.unit==="PERCENT"?`${l.letterSpacing.value}%`:"0":"0"});i.sort((l,o)=>l.name.localeCompare(o.name)),figma.ui.postMessage({type:"figma-text-styles-loaded",issueId:t.issueId,styles:i})}catch(e){console.error("Error getting text styles:",e),figma.ui.postMessage({type:"figma-text-styles-loaded",issueId:t.issueId,styles:[],error:e.message})}break}case"apply-figma-text-style":{try{let e=t.issue,i=t.styleId,l=t.styleName,o=e?e.id:null;if(!e||!e.id)throw new Error("Invalid issue data");if(!i)throw new Error("Style ID is required");let n=e.id,a=figma.getNodeById(n);if(!a||a.type!=="TEXT"){figma.notify("\u26A0\uFE0F Node is not a text node"),figma.ui.postMessage({type:"apply-typography-style-result",issueId:o,success:!1,message:"\u26A0\uFE0F Node is not a text node"});break}if(!figma.getStyleById(i))throw new Error(`Text style "${l}" not found`);a.textStyleId=i,figma.notify(`\u2705 Applied text style "${l}"`),figma.ui.postMessage({type:"apply-typography-style-result",issueId:o,success:!0,message:`\u2705 Applied text style "${l}"`})}catch(e){let i=e&&e.message?e.message:"Unknown error occurred";figma.notify(`\u274C Error applying style: ${i}`),console.error("Error applying Figma text style:",e),figma.ui.postMessage({type:"apply-typography-style-result",issueId,success:!1,message:`\u274C Error: ${i}`})}break}case"fix-color-issue":{try{let e=t.issue,i=t.color,l=e?e.id:null;if(!e||!e.id)throw new Error("Invalid issue data");if(!i||!i.startsWith("#"))throw new Error("Invalid color format");let o=e.id,n=figma.getNodeById(o);if(!n){figma.notify("\u26A0\uFE0F Node not found"),figma.ui.postMessage({type:"fix-issue-result",issueId:l,success:!1,message:"\u26A0\uFE0F Node not found"});break}let a=i.replace("#",""),s=parseInt(a.substring(0,2),16)/255,r=parseInt(a.substring(2,4),16)/255,f=parseInt(a.substring(4,6),16)/255,c={r:s,g:r,b:f};if("fills"in n&&Array.isArray(n.fills)&&n.fills.length>0){let d=n.fills.map(p=>p.type==="SOLID"&&p.visible!==!1?{type:"SOLID",color:c,opacity:p.opacity!==void 0?p.opacity:1,visible:p.visible!==void 0?p.visible:!0}:p);n.fills=d}if("strokes"in n&&Array.isArray(n.strokes)&&n.strokes.length>0){let d=n.strokes.map(p=>p.type==="SOLID"&&p.visible!==!1?{type:"SOLID",color:c,opacity:p.opacity!==void 0?p.opacity:1,visible:p.visible!==void 0?p.visible:!0}:p);n.strokes=d}figma.notify(`\u2705 Changed color to ${i}`),figma.ui.postMessage({type:"fix-issue-result",issueId:l,success:!0,message:`\u2705 Changed color to ${i}`})}catch(e){let i=e&&e.message?e.message:"Unknown error occurred";figma.notify(`\u274C Error fixing color: ${i}`),console.error("Error fixing color:",e),figma.ui.postMessage({type:"fix-issue-result",issueId,success:!1,message:`\u274C Error: ${i}`})}break}case"fix-spacing-issue":{try{let e=t.issue,i=t.propertyName,l=t.value,o=e?e.id:null;if(!e||!e.id)throw new Error("Invalid issue data");if(!i||!["paddingLeft","paddingRight","paddingTop","paddingBottom","itemSpacing"].includes(i))throw new Error("Invalid property name");if(typeof l!="number"||l<0)throw new Error("Invalid spacing value");let n=e.id,a=figma.getNodeById(n);if(!a){figma.notify("\u26A0\uFE0F Node not found"),figma.ui.postMessage({type:"fix-issue-result",issueId:o,success:!1,message:"\u26A0\uFE0F Node not found"});break}if(a.type!=="FRAME"&&a.type!=="COMPONENT"&&a.type!=="INSTANCE")throw new Error("Node does not support spacing properties");if(!a.layoutMode||a.layoutMode==="NONE")throw new Error("Auto-layout is not enabled. Please enable auto-layout first.");i==="paddingLeft"?a.paddingLeft=l:i==="paddingRight"?a.paddingRight=l:i==="paddingTop"?a.paddingTop=l:i==="paddingBottom"?a.paddingBottom=l:i==="itemSpacing"&&(a.itemSpacing=l),figma.notify(`\u2705 Changed ${i} to ${l}px`),figma.ui.postMessage({type:"fix-issue-result",issueId:o,success:!0,message:`\u2705 Changed ${i} to ${l}px`})}catch(e){let i=e&&e.message?e.message:"Unknown error occurred";figma.notify(`\u274C Error fixing spacing: ${i}`),console.error("Error fixing spacing:",e),figma.ui.postMessage({type:"fix-issue-result",issueId,success:!1,message:`\u274C Error: ${i}`})}break}case"fix-text-size-issue":{try{let e=t.issue,i=t.fontSize,l=e?e.id:null;if(!e||!e.id)throw new Error("Invalid issue data");if(typeof i!="number"||i<14)throw new Error("Font size must be at least 14px for ADA compliance");let o=e.id,n=figma.getNodeById(o);if(!n||n.type!=="TEXT"){figma.notify("\u26A0\uFE0F Node is not a text node"),figma.ui.postMessage({type:"fix-issue-result",issueId:l,success:!1,message:"\u26A0\uFE0F Node is not a text node"});break}let a=e.fontName||n.fontName||{family:"Inter",style:"Regular"};try{await figma.loadFontAsync(a)}catch(s){try{await figma.loadFontAsync({family:a.family,style:"Regular"}),a.style="Regular"}catch(r){throw new Error(`Font "${a.family}" could not be loaded. Please ensure it's installed.`)}}n.fontSize=i,n.fontName=a,figma.notify(`\u2705 Changed font size to ${i}px`),figma.ui.postMessage({type:"fix-issue-result",issueId:l,success:!0,message:`\u2705 Changed font size to ${i}px`})}catch(e){let i=e&&e.message?e.message:"Unknown error occurred";figma.notify(`\u274C Error fixing text size: ${i}`),console.error("Error fixing text size:",e),figma.ui.postMessage({type:"fix-issue-result",issueId,success:!1,message:`\u274C Error: ${i}`})}break}case"get-contrast-colors":{try{let l=function(o){try{let n=o.valuesByMode;if(!n||Object.keys(n).length===0)return null;let a=Object.keys(n)[0],s=n[a];if(s&&typeof s=="object"&&"type"in s&&s.type==="VARIABLE_ALIAS"){let r=figma.variables.getVariableById(s.id);return r?l(r):null}if(s&&typeof s=="object"&&"r"in s&&"g"in s&&"b"in s){let r=Math.round(s.r*255),f=Math.round(s.g*255),c=Math.round(s.b*255);return"#"+r.toString(16).padStart(2,"0")+f.toString(16).padStart(2,"0")+c.toString(16).padStart(2,"0")}return null}catch(n){return console.warn("Error resolving color value:",n),null}},e=t.issue,i=[];try{let o=figma.variables.getLocalVariables();for(let n of o)if(n.resolvedType==="COLOR"){let a=l(n);a&&i.push({source:"variable",id:n.id,name:n.name,hex:a.toUpperCase(),variable:n})}}catch(o){console.warn("Error getting variables:",o)}try{let o=figma.getLocalPaintStyles();for(let n of o)if(n.paints&&n.paints.length>0){let a=n.paints[0];if(a.type==="SOLID"&&a.color){let s=a.color,r=Math.round(s.r*255),f=Math.round(s.g*255),c=Math.round(s.b*255),d="#"+r.toString(16).padStart(2,"0")+f.toString(16).padStart(2,"0")+c.toString(16).padStart(2,"0");i.push({source:"style",id:n.id,name:n.name,hex:d.toUpperCase(),style:n})}}}catch(o){console.warn("Error getting paint styles:",o)}figma.ui.postMessage({type:"contrast-colors-loaded",issueId:e.id,colors:i})}catch(e){console.error("Error getting contrast colors:",e),figma.ui.postMessage({type:"contrast-colors-loaded",issueId:t.issue.id,colors:[],error:e.message})}break}case"fix-contrast-issue":{try{let e=t.issue,i=t.color,l=e?e.id:null;if(!e||!e.id)throw new Error("Invalid issue data");if(!i||!i.startsWith("#"))throw new Error("Invalid color format");let o=e.id,n=figma.getNodeById(o);if(!n||n.type!=="TEXT"){figma.notify("\u26A0\uFE0F Node is not a text node"),figma.ui.postMessage({type:"fix-issue-result",issueId:l,success:!1,message:"\u26A0\uFE0F Node is not a text node"});break}let a=i.replace("#",""),s=parseInt(a.substring(0,2),16)/255,r=parseInt(a.substring(2,4),16)/255,f=parseInt(a.substring(4,6),16)/255,c={r:s,g:r,b:f};if("fills"in n&&Array.isArray(n.fills)&&n.fills.length>0){let d=n.fills.map(p=>p.type==="SOLID"&&p.visible!==!1?{type:"SOLID",color:c,opacity:p.opacity!==void 0?p.opacity:1,visible:p.visible!==void 0?p.visible:!0}:p);n.fills=d}else n.fills=[{type:"SOLID",color:c,opacity:1,visible:!0}];figma.notify(`\u2705 Changed text color to ${i}`),figma.ui.postMessage({type:"fix-issue-result",issueId:l,success:!0,message:`\u2705 Changed text color to ${i}`})}catch(e){let i=e&&e.message?e.message:"Unknown error occurred";figma.notify(`\u274C Error fixing contrast: ${i}`),console.error("Error fixing contrast:",e),figma.ui.postMessage({type:"fix-issue-result",issueId,success:!1,message:`\u274C Error: ${i}`})}break}case"fix-empty-frame-issue":{let e=null;try{let i=t.issue;if(e=i?i.id:null,!i||!i.id)throw new Error("Invalid issue data");let l=i.id,o=figma.getNodeById(l);if(!o||o.type!=="FRAME"&&o.type!=="COMPONENT"){figma.notify("\u26A0\uFE0F Node is not a frame or component"),figma.ui.postMessage({type:"fix-issue-result",issueId:e,success:!1,message:"\u26A0\uFE0F Node is not a frame or component"});break}if(!("children"in o)||o.children.length!==1){figma.notify("\u26A0\uFE0F Frame does not have exactly one child"),figma.ui.postMessage({type:"fix-issue-result",issueId:e,success:!1,message:"\u26A0\uFE0F Frame does not have exactly one child"});break}let n=o.children[0],a=o.name||"",s=n.name||"",r=a&&!/frame|group/i.test(a),f=_(o),c=o.paddingLeft&&o.paddingLeft>0||o.paddingRight&&o.paddingRight>0||o.paddingTop&&o.paddingTop>0||o.paddingBottom&&o.paddingBottom>0;if(r&&(f||c)){figma.notify("\u2705 Frame kept (has meaningful name and style config)"),figma.ui.postMessage({type:"fix-issue-result",issueId:e,success:!0,message:"\u2705 Frame kept (has meaningful name and style config)"});break}r&&!s?n.name=a:r&&s&&s!==a&&(n.name=`${a} ${s}`);let d=o.parent;if(!d||!("appendChild"in d))throw new Error("Cannot remove frame: parent is not a valid container");let p=d,y=null;for(;p&&p.type!=="PAGE";){if(p.type==="INSTANCE"){y=p;break}p=p.parent}if(y){figma.notify("\u23ED\uFE0F Skipped: frame is inside a component instance (read-only)."),figma.ui.postMessage({type:"fix-issue-result",issueId:e,success:!0,message:""});break}if(ie(o)){figma.notify("\u23ED\uFE0F Skipped: frame is inside a component instance (read-only)."),figma.ui.postMessage({type:"fix-issue-result",issueId:e,success:!0,message:""});break}try{let g=o.x+(n.x||0),m=o.y+(n.y||0),w=n.clone();w.x=g,w.y=m;let b=d.children.indexOf(o);d.insertChild(b,w),o.remove(),figma.notify(`\u2705 Removed redundant frame, kept child "${w.name}"`),figma.ui.postMessage({type:"fix-issue-result",issueId:e,success:!0,message:`\u2705 Removed redundant frame, kept child "${w.name}"`})}catch(g){throw g.message&&g.message.includes("instance")?new Error("Cannot modify frame: The frame's parent is a component instance. To fix this, right-click the component instance and select 'Edit Component' to enter Design Mode, then try again."):g}}catch(i){let l=i&&i.message?i.message:"Unknown error occurred";figma.notify(`\u274C Error fixing empty frame: ${l}`),console.error("Error fixing empty frame:",i),console.error("Error fixing empty frame:",l),figma.ui.postMessage({type:"fix-issue-result",issueId:e,success:!1,message:`\u274C Error: ${l}`})}break}case"fix-autolayout-issue":{try{let e=t.issue,i=e?e.id:null;if(!e||!e.id)throw new Error("Invalid issue data");let l=e.id,o=figma.getNodeById(l);if(!o||o.type!=="FRAME"&&o.type!=="COMPONENT"&&o.type!=="INSTANCE"){figma.notify("\u26A0\uFE0F Node is not a frame, component, or instance"),figma.ui.postMessage({type:"fix-issue-result",issueId:i,success:!1,message:"\u26A0\uFE0F Node is not a frame, component, or instance"});break}let n=o;if(o.type==="INSTANCE"&&o.mainComponent)n=o.mainComponent,console.log(`[fix-autolayout] Node is instance, using main component: ${n.id}`);else if(o.parent&&o.parent.type==="INSTANCE"&&o.parent.mainComponent){let s=o.parent,r=s.mainComponent;if(r&&"children"in r){let f=s.children.indexOf(o);if(f>=0&&f<r.children.length)n=r.children[f],console.log(`[fix-autolayout] Node is inside instance, using corresponding node in main component: ${n.id}`);else{let c=o.name,d=r.children.find(p=>p.name===c);if(d)n=d,console.log(`[fix-autolayout] Node is inside instance, found by name in main component: ${n.id}`);else throw new Error("Cannot enable auto-layout: node is inside an instance. Please switch to Design Mode and edit the main component directly.")}}else throw new Error("Cannot enable auto-layout: node is inside an instance. Please switch to Design Mode and edit the main component directly.")}if(n.layoutMode&&n.layoutMode!=="NONE"){figma.notify("\u2705 Auto-layout is already enabled"),figma.ui.postMessage({type:"fix-issue-result",issueId:i,success:!0,message:"\u2705 Auto-layout is already enabled"});break}let a="HORIZONTAL";if("children"in o&&o.children.length>0){let s=o.children;if(s.length>=2){let r=s[0],f=s[1],c=Math.abs((f.x||0)-(r.x||0));Math.abs((f.y||0)-(r.y||0))>c&&(a="VERTICAL")}}try{if(console.log(`[fix-autolayout] Before enable - layoutMode: ${n.layoutMode}, node type: ${n.type}, node id: ${n.id}`),console.log(`[fix-autolayout] Node locked: ${n.locked}, parent: ${n.parent?n.parent.type:"none"}`),n.locked)throw new Error("Cannot enable auto-layout: node is locked. Please unlock it first.");try{n.layoutMode=a}catch(f){throw console.error("[fix-autolayout] Error setting layoutMode:",f),new Error(`Cannot set layoutMode: ${f.message||f}. The node may be in read-only mode.`)}let s=n.layoutMode;if(console.log(`[fix-autolayout] After enable - layoutMode: ${s}, expected: ${a}`),s==="NONE"||!s)throw console.error(`[fix-autolayout] Failed to enable - layoutMode is still: ${s}`),console.error(`[fix-autolayout] Node info - type: ${n.type}, locked: ${n.locked}, parent type: ${n.parent?n.parent.type:"none"}`),new Error("Failed to enable auto-layout. The node may be locked, in read-only mode, or inside an instance. Please ensure you're in Design Mode and the node is editable.");typeof n.itemSpacing!="number"&&(n.itemSpacing=0),typeof n.paddingLeft!="number"&&(n.paddingLeft=0),typeof n.paddingRight!="number"&&(n.paddingRight=0),typeof n.paddingTop!="number"&&(n.paddingTop=0),typeof n.paddingBottom!="number"&&(n.paddingBottom=0);let r=n.layoutMode;console.log(`[fix-autolayout] Final verify - layoutMode: ${r}, itemSpacing: ${n.itemSpacing}`),figma.notify(`\u2705 Enabled auto-layout (${r.toLowerCase()})`),figma.ui.postMessage({type:"fix-issue-result",issueId:i,success:!0,message:`\u2705 Enabled auto-layout (${r.toLowerCase()})`})}catch(s){let r=s&&s.message?s.message:"Unknown error";throw console.error("[fix-autolayout] Error enabling auto-layout:",s),new Error(`Cannot enable auto-layout: ${r}. Please ensure you're in Design Mode and the node is editable.`)}}catch(e){let i=e&&e.message?e.message:"Unknown error occurred";figma.notify(`\u274C Error enabling auto-layout: ${i}`),console.error("Error enabling auto-layout:",e),figma.ui.postMessage({type:"fix-issue-result",issueId,success:!1,message:`\u274C Error: ${i}`})}break}case"fix-group-issue":{try{let e=t.issue,i=e?e.id:null;if(!e||!e.id)throw new Error("Invalid issue data");let l=e.id,o=figma.getNodeById(l);if(!o){figma.notify("\u26A0\uFE0F Node not found"),figma.ui.postMessage({type:"fix-issue-result",issueId:i,success:!1,message:"\u26A0\uFE0F Node not found"});break}if(o.type!=="GROUP"){figma.notify("\u26A0\uFE0F Node is not a Group"),figma.ui.postMessage({type:"fix-issue-result",issueId:i,success:!1,message:"\u26A0\uFE0F Node is not a Group"});break}if(o.locked)throw new Error("Cannot convert group: node is locked. Please unlock it first.");if(o.parent&&o.parent.type==="INSTANCE")throw new Error("Cannot convert group: node is inside an instance. Please switch to Design Mode and edit the main component directly.");let n=o.name,a=o.children.slice(),s=o.parent,r=s&&"children"in s?s.children.indexOf(o):-1,f=o.x,c=o.y,d=figma.createFrame();d.name=n,d.x=f,d.y=c;let p="HORIZONTAL";if(a.length>0){let y=a[0],g=a[a.length-1],m=Math.abs(g.y-y.y),w=Math.abs(g.x-y.x);m>w&&(p="VERTICAL")}d.layoutMode=p,d.primaryAxisSizingMode="AUTO",d.counterAxisSizingMode="AUTO",d.itemSpacing=0,d.paddingLeft=0,d.paddingRight=0,d.paddingTop=0,d.paddingBottom=0,s&&"children"in s&&(r>=0?s.insertChild(r,d):s.appendChild(d));for(let y of a)try{d.appendChild(y)}catch(g){console.warn(`[fix-group] Could not append child ${y.name}:`,g)}try{let y=figma.getNodeById(o.id);if(y&&y.type==="GROUP"){if("children"in y&&y.children.length===0)try{y.remove(),console.log("[fix-group] Successfully removed empty Group")}catch(g){console.log("[fix-group] Group was already removed or doesn't exist:",g.message)}else if("children"in y&&y.children.length>0){console.log(`[fix-group] Group still has ${y.children.length} children, trying to move them`);let g=y.children.slice();for(let m of g)try{d.appendChild(m)}catch(w){console.warn(`[fix-group] Could not move remaining child ${m.name}:`,w)}try{let m=figma.getNodeById(o.id);m&&m.type==="GROUP"&&("children"in m&&m.children.length===0?(m.remove(),console.log("[fix-group] Successfully removed Group after moving remaining children")):console.warn(`[fix-group] Group still has ${m.children.length} children, cannot remove`))}catch(m){console.log("[fix-group] Group was already removed or doesn't exist:",m.message)}}}else console.log("[fix-group] Group was already removed or converted (node no longer exists or is not a GROUP)")}catch(y){console.log("[fix-group] Group was already removed or doesn't exist:",y.message)}figma.notify(`\u2705 Converted Group to Frame with Auto-layout (${p.toLowerCase()})`),figma.ui.postMessage({type:"fix-issue-result",issueId:i,success:!0,message:`\u2705 Converted Group to Frame with Auto-layout (${p.toLowerCase()})`})}catch(e){let i=e&&e.message?e.message:"Unknown error occurred";figma.notify(`\u274C Error converting group: ${i}`),console.error("Error converting group:",e),figma.ui.postMessage({type:"fix-issue-result",issueId,success:!1,message:`\u274C Error: ${i}`})}break}case"extract-color-styles":{try{let e=figma.getLocalPaintStyles(),i=[];for(let l of e)if(l.paints&&l.paints.length>0){let o=l.paints[0];if(o.type==="SOLID"&&o.color){let n=o.color,a=Math.round(n.r*255),s=Math.round(n.g*255),r=Math.round(n.b*255),f="#"+a.toString(16).padStart(2,"0")+s.toString(16).padStart(2,"0")+r.toString(16).padStart(2,"0");i.push({name:l.name,hex:f.toUpperCase()})}}figma.ui.postMessage({type:"color-styles-extracted",colors:i}),i.length===0?figma.notify("\u26A0\uFE0F No color styles found in this file"):figma.notify(`\u2705 Extracted ${i.length} color styles`)}catch(e){figma.notify(`\u274C Error extracting color styles: ${e.message}`),console.error("Error extracting color styles:",e)}break}case"extract-color-variables":{try{let o=function(n,a){try{let s=n.valuesByMode[a];if(s&&typeof s=="object"&&"type"in s&&s.type==="VARIABLE_ALIAS"){let r=figma.variables.getVariableById(s.id);return r&&r.resolvedType==="COLOR"?o(r,a):null}return s&&typeof s=="object"&&"r"in s&&"g"in s&&"b"in s?s:null}catch(s){return null}},e=figma.variables.getLocalVariables(),i=[],l=new Set;for(let n of e)if(n.resolvedType==="COLOR"&&!l.has(n.id)){l.add(n.id);let a=n.valuesByMode?Object.keys(n.valuesByMode):[];if(a.length>0){let s=a[0],r=o(n,s);if(r){let f=Math.round(r.r*255),c=Math.round(r.g*255),d=Math.round(r.b*255),p="#"+f.toString(16).padStart(2,"0")+c.toString(16).padStart(2,"0")+d.toString(16).padStart(2,"0");i.push({name:n.name,hex:p.toUpperCase()})}}}figma.ui.postMessage({type:"color-variables-extracted",colors:i}),i.length===0?figma.notify("\u26A0\uFE0F No color variables found in this file"):figma.notify(`\u2705 Extracted ${i.length} color variables`)}catch(e){figma.notify(`\u274C Error extracting color variables: ${e.message}`),console.error("Error extracting color variables:",e)}break}case"close":figma.closePlugin();break;case"fix-position-issue":{try{let e=t.issue,i=e?e.id:null;if(!e||!e.id)throw new Error("Invalid issue data");let l=e.id,o=figma.getNodeById(l);if(!o){figma.notify("\u26A0\uFE0F Node not found"),figma.ui.postMessage({type:"fix-issue-result",issueId:i,success:!1,message:"\u26A0\uFE0F Node not found"});break}let n=o;if(o.parent&&o.parent.type==="INSTANCE"&&o.parent.mainComponent){let a=o.parent,s=a.mainComponent;if(s&&"children"in s){let r=a.children.indexOf(o);if(r>=0&&r<s.children.length)n=s.children[r],console.log(`[fix-position] Node is inside instance, using corresponding node in main component: ${n.id}`);else{let f=o.name,c=s.children.find(d=>d.name===f);if(c)n=c,console.log(`[fix-position] Node is inside instance, found by name in main component: ${n.id}`);else throw new Error("Cannot fix position: node is inside an instance. Please switch to Design Mode and edit the main component directly.")}}else throw new Error("Cannot fix position: node is inside an instance. Please switch to Design Mode and edit the main component directly.")}if(n.type==="INSTANCE")throw new Error("Cannot fix position: the node is an instance. Position properties cannot be overridden in instances. Please edit the main component directly.");if(n.locked)throw new Error("Cannot fix position: node is locked. Please unlock it first.");try{n.x=0,n.y=0}catch(a){let s=a&&a.message?a.message:"Unknown error";throw console.error("[fix-position] Error setting position:",a),new Error(`Cannot fix position: ${s}. The node may be inside an instance or have restricted properties.`)}figma.notify(`\u2705 Fixed position to (0, 0) for "${n.name}"`),figma.ui.postMessage({type:"fix-issue-result",issueId:i,success:!0,message:`\u2705 Fixed position to (0, 0) for "${n.name}"`})}catch(e){let i=e&&e.message?e.message:"Unknown error occurred";figma.notify(`\u274C Error fixing position: ${i}`),console.error("Error fixing position:",e),figma.ui.postMessage({type:"fix-issue-result",issueId:t.issue?t.issue.id:null,success:!1,message:`\u274C Error: ${i}`})}break}case"remove-position-layer":{try{let e=t.issue,i=e?e.id:null;if(!e||!e.id)throw new Error("Invalid issue data");let l=e.id,o=figma.getNodeById(l);if(!o){figma.notify("\u26A0\uFE0F Node not found"),figma.ui.postMessage({type:"fix-issue-result",issueId:i,success:!1,message:"\u26A0\uFE0F Node not found"});break}let n=o;if(o.parent&&o.parent.type==="INSTANCE"&&o.parent.mainComponent){let s=o.parent,r=s.mainComponent;if(r&&"children"in r){let f=s.children.indexOf(o);if(f>=0&&f<r.children.length)n=r.children[f],console.log(`[remove-position] Node is inside instance, using corresponding node in main component: ${n.id}`);else{let c=o.name,d=r.children.find(p=>p.name===c);if(d)n=d,console.log(`[remove-position] Node is inside instance, found by name in main component: ${n.id}`);else throw new Error("Cannot remove layer: node is inside an instance. Please switch to Design Mode and edit the main component directly.")}}else throw new Error("Cannot remove layer: node is inside an instance. Please switch to Design Mode and edit the main component directly.")}if(n.type==="INSTANCE")throw new Error("Cannot remove layer: the node is an instance. Please edit the main component directly to remove it.");if(n.locked)throw new Error("Cannot remove layer: node is locked. Please unlock it first.");let a=n.name;try{n.remove()}catch(s){let r=s&&s.message?s.message:"Unknown error";throw console.error("[remove-position] Error removing node:",s),new Error(`Cannot remove layer: ${r}. The node may be inside an instance or have restricted properties.`)}figma.notify(`\u2705 Removed layer "${a}"`),figma.ui.postMessage({type:"fix-issue-result",issueId:i,success:!0,message:`\u2705 Removed layer "${a}"`})}catch(e){let i=e&&e.message?e.message:"Unknown error occurred";figma.notify(`\u274C Error removing layer: ${i}`),console.error("Error removing layer:",e),figma.ui.postMessage({type:"fix-issue-result",issueId:t.issue?t.issue.id:null,success:!1,message:`\u274C Error: ${i}`})}break}case"get-components-for-issue":{try{console.log("[get-components-for-issue] Received request",t);let e=t.issue;if(!e||!e.id)throw console.error("[get-components-for-issue] Invalid issue data",e),new Error("Invalid issue data");console.log("[get-components-for-issue] Issue ID:",e.id);let i=e.id,l=figma.getNodeById(i);if(!l){console.warn("[get-components-for-issue] Node not found for ID:",i),figma.ui.postMessage({type:"components-for-issue-loaded",issueId:e.id,similarComponents:[]});break}console.log("[get-components-for-issue] Node found:",l.name,l.type);let o=q();($.timestamp===Date.now()||$.components.length===0)&&figma.notify("\u23F3 Finding similar components...",{timeout:1e3}),console.log("[get-components-for-issue] Found",o.length,"components in document");let n=(l.name||"").toLowerCase(),a=o.filter(s=>{let r=(s.name||"").toLowerCase();return r.includes(n)||n.includes(r)||r.split(/[\s-_]+/).some(f=>n.includes(f))||n.split(/[\s-_]+/).some(f=>r.includes(f))}).slice(0,5);console.log("[get-components-for-issue] Found",a.length,"similar components"),console.log("[get-components-for-issue] Sending response with issueId:",e.id),figma.ui.postMessage({type:"components-for-issue-loaded",issueId:e.id,similarComponents:a})}catch(e){console.error("Error getting components for issue:",e),figma.ui.postMessage({type:"components-for-issue-loaded",issueId:t.issue?t.issue.id:null,similarComponents:[]})}break}case"get-all-components":{try{console.log("[get-all-components] Received request",t);let e=t.issue;console.log("[get-all-components] Issue:",e);let i=q();($.timestamp===Date.now()||$.components.length===0)&&figma.notify("\u23F3 Loading components...",{timeout:1e3});let l=e?e.id:null;console.log("[get-all-components] Sending response with issueId:",l),figma.ui.postMessage({type:"all-components-loaded",issueId:l,components:i})}catch(e){console.error("Error getting all components:",e),figma.notify(`\u274C Error loading components: ${e.message}`,{timeout:3e3}),figma.ui.postMessage({type:"all-components-loaded",issueId:t.issue?t.issue.id:null,components:[]})}break}case"create-component-from-issue":{try{let e=t.issue,i=t.componentName,l=e?e.id:null;if(!e||!e.id)throw new Error("Invalid issue data");if(!i||!i.trim())throw new Error("Component name is required");let o=e.id,n=figma.getNodeById(o);if(!n)throw new Error("Node not found");if(n.type!=="FRAME")throw new Error("Only frames can be converted to components");let a=n.clone(),s=figma.createComponent();s.name=i.trim(),s.resize(n.width,n.height),"fills"in n&&"fills"in s&&(s.fills=n.fills),"effects"in n&&"effects"in s&&(s.effects=n.effects),"layoutMode"in n&&"layoutMode"in s&&(s.layoutMode=n.layoutMode),"itemSpacing"in n&&"itemSpacing"in s&&(s.itemSpacing=n.itemSpacing),"paddingLeft"in n&&"paddingLeft"in s&&(s.paddingLeft=n.paddingLeft),"paddingRight"in n&&"paddingRight"in s&&(s.paddingRight=n.paddingRight),"paddingTop"in n&&"paddingTop"in s&&(s.paddingTop=n.paddingTop),"paddingBottom"in n&&"paddingBottom"in s&&(s.paddingBottom=n.paddingBottom);for(let d of n.children){let p=d.clone();s.appendChild(p)}let r=n.parent,f=r.children.indexOf(n);r.insertChild(f,s);let c=s.createInstance();c.x=n.x,c.y=n.y,c.name=n.name,r.insertChild(f+1,c),n.remove(),a.remove(),ae({id:s.id,name:s.name,description:s.description||""}),figma.notify(`\u2705 Created component "${i.trim()}" and replaced frame`),figma.ui.postMessage({type:"fix-issue-result",issueId:l,success:!0,message:`\u2705 Created component "${i.trim()}" and replaced frame`})}catch(e){let i=e&&e.message?e.message:"Unknown error occurred";figma.notify(`\u274C Error creating component: ${i}`),console.error("Error creating component:",e),figma.ui.postMessage({type:"fix-issue-result",issueId:t.issue?t.issue.id:null,success:!1,message:`\u274C Error: ${i}`})}break}case"apply-component-to-issue":{try{let e=t.issue,i=t.componentId,l=e?e.id:null;if(!e||!e.id)throw new Error("Invalid issue data");if(!i)throw new Error("Component ID is required");let o=e.id,n=figma.getNodeById(o),a=figma.getNodeById(i);if(!n)throw new Error("Node not found");if(!a||a.type!=="COMPONENT")throw new Error("Component not found");if(n.type!=="FRAME")throw new Error("Only frames can be replaced with component instances");let s=a.createInstance();s.x=n.x,s.y=n.y,s.name=n.name;let r=n.parent,f=r.children.indexOf(n);r.insertChild(f,s),n.remove(),figma.notify(`\u2705 Replaced frame with component "${a.name}"`),figma.ui.postMessage({type:"fix-issue-result",issueId:l,success:!0,message:`\u2705 Replaced frame with component "${a.name}"`})}catch(e){let i=e&&e.message?e.message:"Unknown error occurred";figma.notify(`\u274C Error applying component: ${i}`),console.error("Error applying component:",e),figma.ui.postMessage({type:"fix-issue-result",issueId:t.issue?t.issue.id:null,success:!1,message:`\u274C Error: ${i}`})}break}case"rename-node":{try{let e=t.issue,i=t.newName,l=e?e.id:null;if(!e||!e.id)throw new Error("Invalid issue data");if(!i||!i.trim())throw new Error("Name is required");let o=e.id,n=figma.getNodeById(o);if(!n){figma.notify("\u26A0\uFE0F Node not found"),figma.ui.postMessage({type:"fix-issue-result",issueId:l,success:!1,message:"\u26A0\uFE0F Node not found"});break}if(n.locked)throw new Error("Cannot rename: node is locked. Please unlock it first.");if(n.parent&&n.parent.type==="INSTANCE")throw new Error("Cannot rename: node is inside an instance. Please switch to Design Mode and edit the main component directly.");let a=n.name||"Unnamed";n.name=i.trim(),figma.notify(`\u2705 Renamed "${a}" to "${i.trim()}"`),figma.ui.postMessage({type:"fix-issue-result",issueId:l,success:!0,message:`\u2705 Renamed to "${i.trim()}"`})}catch(e){let i=e&&e.message?e.message:"Unknown error occurred";figma.notify(`\u274C Error renaming: ${i}`),console.error("Error renaming node:",e),figma.ui.postMessage({type:"fix-issue-result",issueId,success:!1,message:`\u274C Error: ${i}`})}break}case"get-project-name":{try{let e=figma.root&&figma.root.name?figma.root.name:"Untitled";figma.ui.postMessage({type:"project-name",name:e})}catch(e){console.error("Failed to get project name",e),figma.ui.postMessage({type:"project-name",name:"Untitled"})}break}case"check-setting-name":{try{let{name:e}=t;if(!e){figma.ui.postMessage({type:"check-setting-name-result",exists:!1});break}let l=(await figma.clientStorage.getAsync(C.savedSettings)||[]).some(o=>o.name===e);figma.ui.postMessage({type:"check-setting-name-result",exists:l,name:e})}catch(e){console.error("Failed to check setting name",e),figma.ui.postMessage({type:"check-setting-name-result",exists:!1})}break}case"save-settings":{try{let{name:e,values:i,forceReplace:l}=t;if(!e||!i){figma.ui.postMessage({type:"save-settings-result",success:!1,error:"Name and values are required"});break}let o=await figma.clientStorage.getAsync(C.savedSettings)||[],n=o.findIndex(s=>s.name===e),a={name:e,values:i,createdAt:n>=0?o[n].createdAt:new Date().toISOString(),updatedAt:new Date().toISOString()};n>=0?o[n]=a:o.push(a),o.sort((s,r)=>new Date(r.updatedAt)-new Date(s.updatedAt)),await figma.clientStorage.setAsync(C.savedSettings,o),figma.ui.postMessage({type:"save-settings-result",success:!0,settings:o}),figma.notify(`\u2705 Settings "${e}" saved successfully`)}catch(e){console.error("Failed to save settings",e),figma.ui.postMessage({type:"save-settings-result",success:!1,error:e.message})}break}case"get-saved-settings":{try{let e=await figma.clientStorage.getAsync(C.savedSettings)||[];e.sort((i,l)=>new Date(l.updatedAt)-new Date(i.updatedAt)),figma.ui.postMessage({type:"saved-settings-list",settings:e})}catch(e){console.error("Failed to get saved settings",e),figma.ui.postMessage({type:"saved-settings-list",settings:[]})}break}case"load-settings":{try{let{name:e}=t;if(!e){figma.ui.postMessage({type:"load-settings-result",success:!1,error:"Name is required"});break}let l=(await figma.clientStorage.getAsync(C.savedSettings)||[]).find(o=>o.name===e);l?(figma.ui.postMessage({type:"load-settings-result",success:!0,values:l.values}),figma.notify(`\u2705 Settings "${e}" loaded successfully`)):figma.ui.postMessage({type:"load-settings-result",success:!1,error:"Setting not found"})}catch(e){console.error("Failed to load settings",e),figma.ui.postMessage({type:"load-settings-result",success:!1,error:e.message})}break}case"remove-settings":{try{let{name:e}=t;if(!e){figma.ui.postMessage({type:"remove-settings-result",success:!1,error:"Name is required"});break}let i=await figma.clientStorage.getAsync(C.savedSettings)||[];i=i.filter(l=>l.name!==e),i.sort((l,o)=>new Date(o.updatedAt)-new Date(l.updatedAt)),await figma.clientStorage.setAsync(C.savedSettings,i),figma.ui.postMessage({type:"remove-settings-result",success:!0,settings:i}),figma.notify(`\u2705 Settings "${e}" removed successfully`)}catch(e){console.error("Failed to remove settings",e),figma.ui.postMessage({type:"remove-settings-result",success:!1,error:e.message})}break}default:break}};console.log("code.js loaded");})();
